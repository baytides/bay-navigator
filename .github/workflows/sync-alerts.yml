name: Sync API Data (Alerts, Weather, Air Quality, Water Levels, Sports)

on:
  # Run every 15 minutes
  schedule:
    - cron: '*/15 * * * *'
  # Allow manual trigger
  workflow_dispatch:
  # Run on changes to sync scripts
  push:
    branches: [main]
    paths:
      - 'scripts/sync-earthquake-alerts.cjs'
      - 'scripts/sync-weather-alerts.cjs'
      - 'scripts/sync-weather-forecast.cjs'
      - 'scripts/sync-air-quality.cjs'
      - 'scripts/sync-water-levels.cjs'
      - 'scripts/sync-sports-data.cjs'
      - 'scripts/lib/azure-blob-upload.cjs'

jobs:
  sync-api-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Sync earthquake alerts from USGS
        run: node scripts/sync-earthquake-alerts.cjs --verbose
        continue-on-error: true
        env:
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

      - name: Sync weather alerts from NWS
        run: node scripts/sync-weather-alerts.cjs --verbose
        continue-on-error: true
        env:
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

      - name: Sync weather forecast from Open-Meteo
        run: node scripts/sync-weather-forecast.cjs --verbose
        continue-on-error: true
        env:
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

      - name: Sync air quality from Open-Meteo
        run: node scripts/sync-air-quality.cjs --verbose
        continue-on-error: true
        env:
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

      - name: Sync water levels from USGS
        run: node scripts/sync-water-levels.cjs --verbose
        continue-on-error: true
        env:
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

      - name: Sync Bay Area sports data
        run: node scripts/sync-sports-data.cjs --verbose
        continue-on-error: true
        env:
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
