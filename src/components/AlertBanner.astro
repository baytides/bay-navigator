---
/**
 * AlertBanner — Site-wide banner for active missing person alerts.
 * Fetches missing-persons.json at runtime and shows a slim banner
 * at the top of the page when there are active cases.
 * Dismissable per session via sessionStorage.
 */
---

<div
  id="alert-banner"
  role="alert"
  aria-live="polite"
  class="hidden fixed top-0 left-0 right-0 z-40 bg-red-600 dark:bg-red-800 text-white text-sm shadow-md"
>
  <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between gap-3">
    <div class="flex items-center gap-2 min-w-0">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-4 h-4 flex-shrink-0"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
        ></path>
      </svg>
      <span id="alert-banner-text" class="truncate"></span>
      <a
        href="/alerts"
        class="flex-shrink-0 underline font-medium hover:text-red-100 transition-colors"
      >
        View details
      </a>
    </div>
    <button
      id="alert-banner-close"
      class="flex-shrink-0 p-1 rounded hover:bg-red-700 dark:hover:bg-red-900 transition-colors"
      aria-label="Dismiss alert banner"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-4 h-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>
</div>

<script>
  (function () {
    const STORAGE_KEY = 'baynavigator_alert_banner_dismissed';
    const banner = document.getElementById('alert-banner');
    const bannerText = document.getElementById('alert-banner-text');
    const closeBtn = document.getElementById('alert-banner-close');

    if (!banner || !bannerText || !closeBtn) return;

    // Check if dismissed this session
    const dismissed = sessionStorage.getItem(STORAGE_KEY);

    // Fetch current alert data
    fetch('https://baytidesstorage.blob.core.windows.net/missing-persons/missing-persons.json')
      .then((r) => (r.ok ? r.json() : null))
      .then((data) => {
        if (!data || !data.cases || data.cases.length === 0) return;

        // Only show banner for cases reported missing within the last 72 hours
        const now = Date.now();
        const HOURS_72 = 72 * 60 * 60 * 1000;

        const recentCases = data.cases.filter((c: any) => {
          if (!c.missingDate) return false;
          // missingDate format is MM/DD/YYYY
          const parts = c.missingDate.split('/');
          if (parts.length !== 3) return false;
          const d = new Date(
            `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`
          );
          return !isNaN(d.getTime()) && now - d.getTime() < HOURS_72;
        });

        if (recentCases.length === 0) return;

        const latest = recentCases[0];
        const agePart = latest.age ? `, age ${latest.age}` : '';
        const cityPart = latest.missingFrom?.city
          ? `, last seen in ${latest.missingFrom.city}`
          : '';

        // Build banner text — focused on the urgent, recent case
        if (recentCases.length === 1) {
          bannerText.textContent = `Missing Person Alert: ${latest.name}${agePart}${cityPart}.`;
        } else {
          bannerText.textContent = `${recentCases.length} new missing person alerts. Most recent: ${latest.name}${agePart}${cityPart}.`;
        }

        // Track dismissal per specific case set (so new cases re-trigger the banner)
        const caseKey = recentCases
          .map((c: any) => c.id)
          .sort()
          .join(',');
        const dismissedKey = sessionStorage.getItem(STORAGE_KEY);

        // Show banner if not dismissed for this exact set of recent cases
        if (dismissedKey !== caseKey) {
          banner.setAttribute('data-case-key', caseKey);
          banner.classList.remove('hidden');
          // Push page content down
          document.body.style.paddingTop = banner.offsetHeight + 'px';
        }
      })
      .catch(() => {
        // Silently fail — don't show banner if data unavailable
      });

    // Close handler — store the case key so same set won't re-trigger
    closeBtn.addEventListener('click', () => {
      banner.classList.add('hidden');
      document.body.style.paddingTop = '';
      // Re-fetch to get the key, or derive from banner's data attribute
      const key = banner.getAttribute('data-case-key') || Date.now().toString();
      sessionStorage.setItem(STORAGE_KEY, key);
    });
  })();
</script>
