---
interface Props {
  code: string;
  name?: string;
  showWeather?: boolean;
  compact?: boolean;
  previewAlert?: boolean;
}

interface AirportStatusData {
  Name: string;
  City: string;
  State: string;
  ICAO: string;
  IATA: string;
  SupportedAirport: boolean;
  Delay: boolean;
  DelayCount: number;
  Status: Array<{ Reason: string }>;
  Weather: {
    Weather: Array<{ Temp: string[] }>;
    Visibility: number[];
    Temp: string[];
    Wind: string[];
    Meta: Array<{ Updated: string }>;
  };
}

const { code, name, showWeather = true, compact = false, previewAlert = false } = Astro.props;

// Fetch airport status at build time (server-side, no CORS issues)
let initialStatus: AirportStatusData | null = null;
try {
  const response = await fetch(`https://external-api.faa.gov/asws/api/airport/status/${code}`);
  if (response.ok) {
    initialStatus = await response.json();
  }
} catch (error) {
  console.error(`Failed to fetch status for ${code}:`, error);
}

// Prepare initial display values from build-time data
const hasData = Boolean(initialStatus);
const hasDelay = previewAlert ? true : (initialStatus?.Delay ?? false);
const delayCount = previewAlert ? 2 : (initialStatus?.DelayCount ?? 0);
const statusClass = hasData || previewAlert ? (hasDelay ? 'delay' : 'ok') : 'unavailable';
const statusText = hasData
  ? hasDelay
    ? 'Delays reported'
    : 'No FAA delays reported'
  : previewAlert
    ? 'Delays reported'
    : 'FAA status unavailable';
const statusDetail = hasData
  ? hasDelay
    ? `${delayCount} active ${delayCount === 1 ? 'delay' : 'delays'}`
    : 'Operations currently normal'
  : previewAlert
    ? `${delayCount} active delays`
    : 'Live FAA status is temporarily unavailable';

const temp = initialStatus?.Weather?.Temp?.[0] || '';
const conditions = initialStatus?.Weather?.Weather?.[0]?.Temp?.[0] || '';
const wind = initialStatus?.Weather?.Wind?.[0] || '';
const visibility = initialStatus?.Weather?.Visibility?.[0];
const weatherItems = [
  temp ? `Temperature: ${temp}` : '',
  conditions ? `Conditions: ${conditions}` : '',
  wind && wind !== 'Calm' ? `Wind: ${wind}` : wind === 'Calm' ? 'Wind: Calm' : '',
  visibility !== undefined && visibility !== null ? `Visibility: ${visibility} mi` : '',
].filter(Boolean);

const updatedRaw = initialStatus?.Weather?.Meta?.[0]?.Updated || '';
let updatedText = '';
if (updatedRaw) {
  const parsed = new Date(updatedRaw);
  if (!Number.isNaN(parsed.getTime())) {
    updatedText = parsed.toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
    });
  }
}

const delays = previewAlert
  ? [{ Reason: 'Ground delay program in effect due to weather and congestion.' }]
  : initialStatus?.Status?.filter(
      (s) => s.Reason && s.Reason !== 'No known delays for this airport'
    ) || [];
---

<div class:list={['airport-status', { compact }]} data-airport={code}>
  <div class="airport-header">
    <span class="airport-code">{code}</span>
    {name && <span class="airport-name">{name}</span>}
    <span class="status-indicator" data-status={statusClass}>
      <span class="status-dot"></span>
      <span class="status-text">{statusText}</span>
    </span>
  </div>
  <p class="status-label">FAA delay status</p>
  <p class="status-detail">{statusDetail}</p>
  {updatedText && <p class="status-updated">Updated: {updatedText}</p>}

  {
    showWeather && (
      <div class="weather-info" data-weather>
        <p class="weather-label">Local weather</p>
        {weatherItems.length > 0 ? (
          <ul class="weather-list">
            {weatherItems.map((item) => (
              <li>{item}</li>
            ))}
          </ul>
        ) : (
          <p class="weather-unavailable">Weather data unavailable</p>
        )}
      </div>
    )
  }

  {
    delays.length > 0 && (
      <div class="delay-info" data-delays>
        <p class="delay-label">Reported delay reasons</p>
        {delays.map((d) => (
          <div class="delay-alert">{d.Reason}</div>
        ))}
      </div>
    )
  }
</div>

<style>
  .airport-status {
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 8px;
    padding: 12px;
    background: var(--card-bg, #fff);
  }

  .airport-status.compact {
    padding: 8px 12px;
  }

  .airport-header {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 4px;
  }

  .airport-code {
    font-weight: 700;
    font-size: 1.1em;
    color: var(--text-primary, #1f2937);
  }

  .airport-name {
    color: var(--text-secondary, #6b7280);
    font-size: 0.9em;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.82rem;
    margin-left: auto;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #94a3b8;
    flex-shrink: 0;
  }

  [data-status='ok'] .status-dot {
    background: #22c55e;
  }

  [data-status='ok'] .status-text {
    color: #16a34a;
  }

  [data-status='delay'] .status-dot {
    background: #f59e0b;
  }

  [data-status='delay'] .status-text {
    color: #d97706;
  }

  [data-status='unavailable'] .status-dot {
    background: #94a3b8;
  }

  [data-status='unavailable'] .status-text {
    color: #6b7280;
  }

  .status-label {
    margin: 0;
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    color: #64748b;
  }

  .status-detail {
    margin: 2px 0 0;
    font-size: 0.86rem;
    color: #334155;
  }

  .status-updated {
    margin: 2px 0 0;
    font-size: 0.76rem;
    color: #64748b;
  }

  .weather-info {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px dashed #cbd5e1;
  }

  .weather-label {
    margin: 0;
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    color: #64748b;
  }

  .weather-list {
    margin: 6px 0 0;
    padding-left: 18px;
    font-size: 0.84rem;
    color: var(--text-secondary, #6b7280);
    line-height: 1.35;
  }

  .weather-unavailable {
    margin: 6px 0 0;
    font-size: 0.82rem;
    color: #64748b;
  }

  .compact .weather-info {
    margin-top: 8px;
  }

  .delay-info {
    margin-top: 10px;
  }

  .delay-label {
    margin: 0 0 6px;
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    color: #92400e;
  }

  :global(.delay-alert) {
    background: #fef3c7;
    border: 1px solid #fbbf24;
    border-radius: 4px;
    padding: 8px 10px;
    font-size: 0.9em;
    color: #92400e;
    margin-top: 4px;
  }

  :global(.delay-alert:first-child) {
    margin-top: 0;
  }

  .compact :global(.delay-alert) {
    padding: 6px 8px;
    font-size: 0.8em;
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .airport-status {
      border-color: var(--border-color, #374151);
      background: var(--card-bg, #1f2937);
    }

    .airport-code {
      color: var(--text-primary, #f9fafb);
    }

    .airport-name {
      color: var(--text-secondary, #9ca3af);
    }

    .status-label,
    .status-updated,
    .weather-label,
    .weather-unavailable {
      color: #94a3b8;
    }

    .status-detail {
      color: #cbd5e1;
    }

    .weather-info {
      border-top-color: #334155;
    }

    .weather-list {
      color: var(--text-secondary, #9ca3af);
    }

    .delay-label {
      color: #fbbf24;
    }

    :global(.delay-alert) {
      background: #78350f;
      border-color: #b45309;
      color: #fef3c7;
    }
  }
</style>
