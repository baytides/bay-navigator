---
/**
 * Language Selector Component
 *
 * Dropdown selector for switching between available languages.
 * Supports 10 languages with browser auto-detection.
 * Persists selection to localStorage and updates UI dynamically.
 */

// All supported locales with their native names and flag emoji
const supportedLocales = [
  { code: 'en', name: 'English', nativeName: 'English', flag: 'ğŸ‡ºğŸ‡¸' },
  { code: 'es', name: 'Spanish', nativeName: 'EspaÃ±ol', flag: 'ğŸ‡ªğŸ‡¸' },
  { code: 'zh-Hans', name: 'Chinese (Simplified)', nativeName: 'ç®€ä½“ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³' },
  { code: 'zh-Hant', name: 'Chinese (Traditional)', nativeName: 'ç¹é«”ä¸­æ–‡', flag: 'ğŸ‡¹ğŸ‡¼' },
  { code: 'vi', name: 'Vietnamese', nativeName: 'Tiáº¿ng Viá»‡t', flag: 'ğŸ‡»ğŸ‡³' },
  { code: 'fil', name: 'Filipino', nativeName: 'Filipino', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'ko', name: 'Korean', nativeName: 'í•œêµ­ì–´', flag: 'ğŸ‡°ğŸ‡·' },
  { code: 'ru', name: 'Russian', nativeName: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹', flag: 'ğŸ‡·ğŸ‡º' },
  { code: 'fr', name: 'French', nativeName: 'FranÃ§ais', flag: 'ğŸ‡«ğŸ‡·' },
  { code: 'ar', name: 'Arabic', nativeName: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ğŸ‡¸ğŸ‡¦', rtl: true },
] as const;
---

<div class="relative" id="language-selector-container">
  <button
    id="language-selector-btn"
    type="button"
    class="flex items-center gap-1.5 px-2 py-1.5 rounded-lg text-neutral-700 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors text-sm"
    aria-label="Select language"
    aria-expanded="false"
    aria-haspopup="listbox"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"
      ></path>
    </svg>
    <span id="current-language" class="hidden sm:inline">English</span>
    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"
      ></path>
    </svg>
  </button>

  <!-- Dropdown menu with scrollable list -->
  <div
    id="language-dropdown"
    class="hidden absolute right-0 top-full mt-1 w-48 max-h-80 overflow-y-auto bg-white dark:bg-neutral-800 rounded-lg shadow-lg border border-neutral-200 dark:border-neutral-700 z-50"
    role="listbox"
    aria-labelledby="language-selector-btn"
  >
    {
      supportedLocales.map((locale, index) => (
        <button
          type="button"
          class="language-option w-full px-4 py-2.5 text-left text-sm text-neutral-700 dark:text-neutral-200 hover:bg-neutral-100 dark:hover:bg-neutral-700 flex items-center justify-between transition-colors"
          data-locale={locale.code}
          data-rtl={locale.rtl ? 'true' : undefined}
          role="option"
          aria-selected={index === 0 ? 'true' : 'false'}
        >
          <span class="flex items-center gap-2">
            <span class="text-base" aria-hidden="true">
              {locale.flag}
            </span>
            <span>{locale.nativeName}</span>
          </span>
          <svg
            class={`w-4 h-4 text-primary-700 dark:text-primary-400 check-icon ${index !== 0 ? 'hidden' : ''}`}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
        </button>
      ))
    }
  </div>
</div>

<script>
  const STORAGE_KEY = 'baynavigator_locale';

  // Supported locales with native names
  const localeInfo: Record<string, { nativeName: string; rtl?: boolean }> = {
    en: { nativeName: 'English' },
    es: { nativeName: 'EspaÃ±ol' },
    'zh-Hans': { nativeName: 'ç®€ä½“ä¸­æ–‡' },
    'zh-Hant': { nativeName: 'ç¹é«”ä¸­æ–‡' },
    vi: { nativeName: 'Tiáº¿ng Viá»‡t' },
    fil: { nativeName: 'Filipino' },
    ko: { nativeName: 'í•œêµ­ì–´' },
    ru: { nativeName: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' },
    fr: { nativeName: 'FranÃ§ais' },
    ar: { nativeName: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', rtl: true },
  };

  // Map browser language codes to our locale codes
  const browserLangMap: Record<string, string> = {
    en: 'en',
    es: 'es',
    zh: 'zh-Hans', // Default Chinese to Simplified
    'zh-cn': 'zh-Hans',
    'zh-sg': 'zh-Hans',
    'zh-hans': 'zh-Hans',
    'zh-tw': 'zh-Hant',
    'zh-hk': 'zh-Hant',
    'zh-mo': 'zh-Hant',
    'zh-hant': 'zh-Hant',
    vi: 'vi',
    fil: 'fil',
    tl: 'fil', // Tagalog -> Filipino
    ko: 'ko',
    ru: 'ru',
    fr: 'fr',
    ar: 'ar',
  };

  /**
   * Detect locale from browser settings
   */
  function detectBrowserLocale(): string | null {
    const languages = navigator.languages || [navigator.language];

    for (const lang of languages) {
      const normalized = lang.toLowerCase();

      // Try exact match first
      if (browserLangMap[normalized]) {
        return browserLangMap[normalized];
      }

      // Try base language (e.g., 'en-US' -> 'en')
      const baseLang = normalized.split('-')[0];
      if (browserLangMap[baseLang]) {
        return browserLangMap[baseLang];
      }
    }

    return null;
  }

  /**
   * Get current locale from storage, browser, or default
   */
  function getLocale(): string {
    // 1. Check localStorage first (user preference)
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored && stored in localeInfo) {
        return stored;
      }
    } catch {
      // localStorage not available
    }

    // 2. Auto-detect from browser settings
    const detected = detectBrowserLocale();
    if (detected) {
      // Save detected locale so user sees consistent experience
      try {
        localStorage.setItem(STORAGE_KEY, detected);
      } catch {
        // Ignore
      }
      return detected;
    }

    // 3. Default to English
    return 'en';
  }

  /**
   * Set locale and apply translations
   */
  function setLocale(locale: string): void {
    if (!(locale in localeInfo)) return;

    const prevLocale = localStorage.getItem(STORAGE_KEY) || 'en';

    try {
      localStorage.setItem(STORAGE_KEY, locale);
    } catch {
      // localStorage not available
    }

    // Update HTML lang attribute
    document.documentElement.lang = locale;

    // Handle RTL languages
    const info = localeInfo[locale];
    if (info?.rtl) {
      document.documentElement.dir = 'rtl';
    } else {
      document.documentElement.dir = 'ltr';
    }

    // Dispatch event for other components
    window.dispatchEvent(new CustomEvent('locale-changed', { detail: { locale } }));

    // Update UI
    updateUI(locale);

    // Reload page to apply translations if locale changed
    if (prevLocale !== locale) {
      window.location.reload();
    }
  }

  /**
   * Update selector UI to reflect current locale
   */
  function updateUI(locale: string): void {
    // Update current language display
    const currentLangEl = document.getElementById('current-language');
    if (currentLangEl) {
      currentLangEl.textContent = localeInfo[locale]?.nativeName || 'English';
    }

    // Update checkmarks
    const options = document.querySelectorAll('.language-option');
    options.forEach((option) => {
      const optionLocale = option.getAttribute('data-locale');
      const checkIcon = option.querySelector('.check-icon');
      const isSelected = optionLocale === locale;

      option.setAttribute('aria-selected', String(isSelected));
      if (checkIcon) {
        checkIcon.classList.toggle('hidden', !isSelected);
      }
    });
  }

  /**
   * Initialize the language selector
   */
  function setupLanguageSelector(): void {
    const btn = document.getElementById('language-selector-btn');
    const dropdown = document.getElementById('language-dropdown');
    const options = document.querySelectorAll('.language-option');

    if (!btn || !dropdown) return;

    // Initialize with current locale
    const currentLocale = getLocale();
    updateUI(currentLocale);
    document.documentElement.lang = currentLocale;

    // Set RTL if needed
    const info = localeInfo[currentLocale];
    if (info?.rtl) {
      document.documentElement.dir = 'rtl';
    }

    // Toggle dropdown
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = !dropdown.classList.contains('hidden');
      dropdown.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', String(!isOpen));
    });

    // Handle option selection
    options.forEach((option) => {
      option.addEventListener('click', () => {
        const locale = option.getAttribute('data-locale');
        if (locale) {
          setLocale(locale);
          dropdown.classList.add('hidden');
          btn.setAttribute('aria-expanded', 'false');
        }
      });
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (!btn.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {
        dropdown.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
      }
    });

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !dropdown.classList.contains('hidden')) {
        dropdown.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
        btn.focus();
      }
    });

    // Keyboard navigation within dropdown
    dropdown.addEventListener('keydown', (e) => {
      const focusedOption = document.activeElement;
      const optionsList = Array.from(options);
      const currentIndex = optionsList.indexOf(focusedOption as Element);

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        const nextIndex = (currentIndex + 1) % optionsList.length;
        (optionsList[nextIndex] as HTMLElement).focus();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prevIndex = (currentIndex - 1 + optionsList.length) % optionsList.length;
        (optionsList[prevIndex] as HTMLElement).focus();
      } else if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        (focusedOption as HTMLElement)?.click();
      }
    });
  }

  // Initialize on page load
  setupLanguageSelector();
</script>
