---
import BaseLayout from '../layouts/BaseLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import fs from 'node:fs';
import path from 'node:path';

// Load sports data
const sportsDataPath = path.join(process.cwd(), 'public', 'data', 'sports-data.json');
let sportsData: any = { teams: {}, todaysGames: [] };
try {
  sportsData = JSON.parse(fs.readFileSync(sportsDataPath, 'utf8'));
} catch (e) {
  console.error('Failed to load sports data:', e);
}

const teams = sportsData.teams || {};
const todaysGames = sportsData.todaysGames || [];
const generated = sportsData.generated ? new Date(sportsData.generated) : null;

// Team display config â€” colors via Tailwind classes, no custom SVGs
const teamConfig: Record<
  string,
  { badge: string; badgeBg: string; borderColor: string; accentBg: string; accentText: string }
> = {
  warriors: {
    badge: 'NBA',
    badgeBg: 'bg-blue-700 text-yellow-300',
    borderColor: 'border-blue-600',
    accentBg: 'bg-blue-50 dark:bg-blue-900/20',
    accentText: 'text-blue-700 dark:text-blue-300',
  },
  giants: {
    badge: 'MLB',
    badgeBg: 'bg-orange-600 text-white',
    borderColor: 'border-orange-500',
    accentBg: 'bg-orange-50 dark:bg-orange-900/20',
    accentText: 'text-orange-700 dark:text-orange-300',
  },
  '49ers': {
    badge: 'NFL',
    badgeBg: 'bg-red-700 text-yellow-300',
    borderColor: 'border-red-600',
    accentBg: 'bg-red-50 dark:bg-red-900/20',
    accentText: 'text-red-700 dark:text-red-300',
  },
  sharks: {
    badge: 'NHL',
    badgeBg: 'bg-teal-700 text-white',
    borderColor: 'border-teal-600',
    accentBg: 'bg-teal-50 dark:bg-teal-900/20',
    accentText: 'text-teal-700 dark:text-teal-300',
  },
};

const TEAM_LINKS: Record<string, { schedule: string; standings: string; news: string }> = {
  warriors: {
    schedule: 'https://www.nba.com/warriors/schedule',
    standings: 'https://www.nba.com/standings',
    news: 'https://www.nba.com/warriors',
  },
  giants: {
    schedule: 'https://www.mlb.com/giants/schedule',
    standings: 'https://www.mlb.com/standings',
    news: 'https://www.mlb.com/giants',
  },
  '49ers': {
    schedule: 'https://www.49ers.com/schedule/',
    standings: 'https://www.nfl.com/standings/',
    news: 'https://www.49ers.com/news/',
  },
  sharks: {
    schedule: 'https://www.nhl.com/sharks/schedule',
    standings: 'https://www.nhl.com/standings',
    news: 'https://www.nhl.com/sharks/news',
  },
};

const TEAM_GAMECENTER_LINKS: Record<string, string> = {
  warriors: 'https://www.nba.com/warriors/schedule',
  giants: 'https://www.mlb.com/giants/schedule',
  '49ers': 'https://www.49ers.com/schedule/',
  sharks: 'https://www.nhl.com/sharks/schedule',
};

const TEAM_CATALOG: Record<string, { name: string; sport: string; themeId: string }> = {
  warriors: { name: 'Golden State Warriors', sport: 'NBA', themeId: 'warriors' },
  giants: { name: 'San Francisco Giants', sport: 'MLB', themeId: 'giants' },
  '49ers': { name: 'San Francisco 49ers', sport: 'NFL', themeId: '49ers' },
  sharks: { name: 'San Jose Sharks', sport: 'NHL', themeId: 'sharks' },
};

// Order teams: active season first
const teamOrder = ['warriors', 'giants', '49ers', 'sharks'];
const orderedTeams = teamOrder.map((id) => ({
  id,
  ...(TEAM_CATALOG[id] || { name: id, sport: 'SPORT', themeId: id }),
  ...(teams[id] || {}),
  hasLiveData: Boolean(teams[id]),
  config: teamConfig[id],
}));

function formatDate(dateStr: string): string {
  try {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  } catch {
    return dateStr;
  }
}

function getWinPct(team: any): string {
  const wins = Number(team?.record?.wins ?? 0);
  const losses = Number(team?.record?.losses ?? 0);
  const total = wins + losses;
  if (!total) return '--';
  return (wins / total).toFixed(3).replace(/^0/, '');
}

function getGamesPlayed(team: any): number {
  const wins = Number(team?.record?.wins ?? 0);
  const losses = Number(team?.record?.losses ?? 0);
  return wins + losses;
}

function getLastNRecord(team: any, n = 5): string {
  const recent = Array.isArray(team?.recentResults) ? team.recentResults.slice(0, n) : [];
  if (recent.length === 0) return '--';
  const wins = recent.filter((r: string) => r === 'W').length;
  const losses = recent.filter((r: string) => r === 'L').length;
  return `${wins}-${losses}`;
}

function getCurrentRun(team: any): string {
  if (team?.streak) return team.streak;
  const recent = Array.isArray(team?.recentResults) ? team.recentResults : [];
  if (recent.length === 0) return 'None';
  const first = recent[0];
  let count = 0;
  for (const r of recent) {
    if (r === first) count++;
    else break;
  }
  return `${first}${count}`;
}

function normalizeTeamId(value: string | undefined): string | null {
  if (!value) return null;
  const v = value.toLowerCase();
  if (v.includes('warriors')) return 'warriors';
  if (v.includes('giants')) return 'giants';
  if (v.includes('49ers') || v.includes('niners')) return '49ers';
  if (v.includes('sharks') || v.includes('san jose')) return 'sharks';
  return null;
}

function getWatchInfo(
  teamId: string | null,
  game: any
): { label: string; url?: string; network?: string } {
  if (!game) return { label: 'Gamecenter' };
  const explicitUrl =
    game.watchUrl ||
    game.watchURL ||
    game.watch ||
    game.streamUrl ||
    game.gameUrl ||
    game.gameURL ||
    game.url;
  const network = game.network || game.broadcast || game.tv || game.channel;
  if (explicitUrl) return { label: 'Watch', url: explicitUrl, network };
  if (network && teamId)
    return { label: 'Where to watch', url: TEAM_GAMECENTER_LINKS[teamId], network };
  if (teamId) return { label: 'Gamecenter', url: TEAM_GAMECENTER_LINKS[teamId] };
  return { label: 'Gamecenter' };
}

function parseGameDate(dateStr: string | undefined): Date | null {
  if (!dateStr) return null;
  const d = new Date(`${dateStr}T12:00:00`);
  return Number.isNaN(d.getTime()) ? null : d;
}

function inSeasonBySport(team: any): boolean {
  const now = new Date();
  const month = now.getMonth() + 1; // 1-12
  const sport = String(team?.sport || '').toUpperCase();
  if (sport === 'MLB') return month >= 2 && month <= 11; // includes spring training window
  if (sport === 'NBA' || sport === 'NHL') return month >= 9 || month <= 6;
  if (sport === 'NFL') return month >= 8 || month <= 2;
  return false;
}

function isOffSeason(team: any): boolean {
  const now = new Date();
  if (inSeasonBySport(team)) return false;
  const next = parseGameDate(team?.nextGame?.date);
  const last = parseGameDate(team?.lastGame?.date);
  if (next) {
    const daysUntil = Math.floor((next.getTime() - now.getTime()) / 86400000);
    if (daysUntil <= 60) return false;
  }
  if (last) {
    const daysSince = Math.floor((now.getTime() - last.getTime()) / 86400000);
    if (daysSince <= 45) return false;
  }
  return true;
}

function isSpringTraining(team: any): boolean {
  const sport = String(team?.sport || '').toUpperCase();
  if (sport !== 'MLB') return false;
  const next = parseGameDate(team?.nextGame?.date);
  if (!next) return false;
  const month = next.getMonth() + 1;
  return month <= 3; // Feb/Mar games treated as spring training context
}

function getSpringRecord(team: any): { wins: number; losses: number } | null {
  if (!isSpringTraining(team)) return null;
  const explicit = team?.springTraining?.record;
  if (explicit && Number.isFinite(explicit.wins) && Number.isFinite(explicit.losses)) {
    return { wins: Number(explicit.wins), losses: Number(explicit.losses) };
  }
  const recent = Array.isArray(team?.recentResults) ? team.recentResults : [];
  if (recent.length === 0) return null;
  const wins = recent.filter((r: string) => r === 'W').length;
  const losses = recent.filter((r: string) => r === 'L').length;
  return { wins, losses };
}

function getDisplayNextGame(team: any): any {
  if (isSpringTraining(team) && team?.springTraining?.nextGame) return team.springTraining.nextGame;
  return team?.nextGame;
}

function getDisplayLastGame(team: any): any {
  if (isSpringTraining(team) && team?.springTraining?.lastGame) return team.springTraining.lastGame;
  return team?.lastGame;
}

const todaysTeamIds = new Set(
  (todaysGames || []).map((g: any) => normalizeTeamId(g.team || g.teamId)).filter(Boolean)
);
---

<BaseLayout
  title="Bay Area Sports - Bay Navigator"
  description="Live scores, standings, and schedules for Bay Area teams including the Warriors, Giants, 49ers, and Sharks."
>
  <main class="container mx-auto px-4 py-8 max-w-5xl" id="main-content">
    <Breadcrumb items={[{ label: 'Sports', href: '/sports' }]} />

    <!-- Hero Section -->
    <div class="text-center mb-8 sports-hero">
      <h1 class="text-3xl md:text-4xl font-bold text-neutral-900 dark:text-white mb-4">
        Bay Area Game Center
      </h1>
      <p class="text-lg text-neutral-700 dark:text-neutral-300 max-w-2xl mx-auto">
        Track Bay Area teams in one place with live status, upcoming matchups, standings, and roster
        details.
      </p>
      <p class="text-sm text-neutral-600 dark:text-neutral-400 mt-3">
        {
          todaysGames.length > 0
            ? `${todaysGames.length} game${todaysGames.length > 1 ? 's' : ''} live or scheduled today`
            : 'No games live right now'
        }
      </p>
    </div>

    <!-- At-a-glance -->
    <section class="mb-6" aria-label="Sports summary">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div class="sports-stat-card">
          <div class="sports-stat-label">Teams tracked</div>
          <div class="sports-stat-value">{orderedTeams.length}</div>
        </div>
        <div class="sports-stat-card">
          <div class="sports-stat-label">Games today</div>
          <div class="sports-stat-value">{todaysGames.length}</div>
        </div>
        <div class="sports-stat-card">
          <div class="sports-stat-label">Last refresh</div>
          <div class="sports-stat-value text-base">
            {
              generated
                ? generated.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
                : '--'
            }
          </div>
        </div>
      </div>
    </section>

    <!-- Today's Games Banner -->
    {
      todaysGames.length > 0 && (
        <div class="mb-8 p-4 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800">
          <div class="flex items-center gap-2 mb-2">
            <span class="relative flex h-2.5 w-2.5">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75" />
              <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500" />
            </span>
            <h2 class="font-semibold text-green-800 dark:text-green-200 text-sm">Games Today</h2>
          </div>
          <div class="space-y-2">
            {todaysGames.map((game: any) =>
              (() => {
                const teamId = normalizeTeamId(game.team || game.teamId);
                const watch = getWatchInfo(teamId, game);
                return (
                  <div class="flex items-center justify-between gap-3 text-sm bg-white/70 dark:bg-neutral-900/30 rounded-lg px-3 py-2">
                    <div class="min-w-0">
                      <span class="text-green-700 dark:text-green-300 block truncate">
                        {game.team} vs {game.opponent}
                      </span>
                      {watch.network && (
                        <span class="text-[11px] text-green-700/80 dark:text-green-300/80 block mt-0.5">
                          {watch.label}: {watch.network}
                        </span>
                      )}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      <span class="text-green-600 dark:text-green-400 font-medium whitespace-nowrap">
                        {game.time || game.status}
                      </span>
                      {watch.url && (
                        <a
                          href={watch.url}
                          target="_blank"
                          rel="noopener"
                          class="sports-watch-link"
                        >
                          {watch.label}
                        </a>
                      )}
                    </div>
                  </div>
                );
              })()
            )}
          </div>
        </div>
      )
    }

    <!-- Team Cards -->
    <section aria-labelledby="teams-heading" class="mb-10">
      <h2 id="teams-heading" class="sr-only">Team Standings and Schedules</h2>
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
        {
          orderedTeams.map((team) => (
            <article
              class:list={[
                'bg-white dark:bg-neutral-800 rounded-xl shadow-sm border-l-4 border border-neutral-200 dark:border-neutral-700 overflow-hidden',
                team.config?.borderColor || 'border-primary-500',
                isOffSeason(team) && 'sports-team-inactive',
              ]}
              aria-labelledby={`team-${team.id}-name`}
            >
              <details class="sports-team-accordion" data-locked="true" open={true}>
                <summary
                  class:list={['sports-team-summary', 'sports-team-summary-locked']}
                  aria-disabled="true"
                >
                  <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3 min-w-0">
                      <h3
                        id={`team-${team.id}-name`}
                        class="text-xl font-bold text-neutral-900 dark:text-white truncate"
                      >
                        {team.name}
                      </h3>
                      <span
                        class:list={[
                          'text-xs font-bold px-2 py-0.5 rounded-full flex-shrink-0',
                          team.config?.badgeBg || 'bg-neutral-600 text-white',
                        ]}
                      >
                        {team.config?.badge || team.sport}
                      </span>
                      {todaysTeamIds.has(team.id) && (
                        <span class="text-[11px] font-bold px-2 py-0.5 rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 border border-green-300 dark:border-green-700 flex-shrink-0">
                          TODAY
                        </span>
                      )}
                      {isOffSeason(team) && (
                        <span class="text-[11px] font-bold px-2 py-0.5 rounded-full bg-neutral-200 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 border border-neutral-300 dark:border-neutral-600 flex-shrink-0">
                          OFFSEASON
                        </span>
                      )}
                      {isSpringTraining(team) && (
                        <span class="text-[11px] font-bold px-2 py-0.5 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-200 border border-orange-300 dark:border-orange-700 flex-shrink-0">
                          SPRING TRAINING
                        </span>
                      )}
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">
                        {team.record?.wins ?? '-'}-{team.record?.losses ?? '-'}
                      </span>
                      {team.isPlayoffs && (
                        <span class="text-xs font-bold px-2.5 py-1 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 border border-yellow-300 dark:border-yellow-700">
                          PLAYOFFS
                        </span>
                      )}
                    </div>
                  </div>
                </summary>

                <div class="p-5 sm:p-6 pt-2">
                  {!team.hasLiveData && (
                    <div class="mb-4 rounded-lg border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20 px-3 py-2 text-xs text-blue-800 dark:text-blue-200">
                      Live stats for this team are still syncing. Schedule and team links are
                      available below.
                    </div>
                  )}
                  {isSpringTraining(team) && (
                    <div class="mb-3 flex flex-wrap gap-2">
                      <span class="text-[11px] font-semibold px-2 py-0.5 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-200 border border-orange-300 dark:border-orange-700">
                        Spring Training
                      </span>
                      <span class="text-[11px] font-semibold px-2 py-0.5 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 border border-blue-300 dark:border-blue-700">
                        Regular Season
                      </span>
                    </div>
                  )}

                  {/* Stats row */}
                  <div class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-4 mb-5">
                    {/* Spring Record (MLB spring only) */}
                    {isSpringTraining(team) && (
                      <div
                        class:list={[
                          'rounded-lg p-3',
                          team.config?.accentBg || 'bg-neutral-50 dark:bg-neutral-700',
                        ]}
                      >
                        <div class="text-xs text-neutral-700 dark:text-neutral-400 mb-1">
                          Spring Record
                        </div>
                        <div
                          class:list={[
                            'text-lg font-bold',
                            team.config?.accentText || 'text-neutral-900 dark:text-white',
                          ]}
                        >
                          {getSpringRecord(team)?.wins ?? '-'}-
                          {getSpringRecord(team)?.losses ?? '-'}
                        </div>
                      </div>
                    )}

                    {/* Record */}
                    <div
                      class:list={[
                        'rounded-lg p-3',
                        team.config?.accentBg || 'bg-neutral-50 dark:bg-neutral-700',
                      ]}
                    >
                      <div class="text-xs text-neutral-700 dark:text-neutral-400 mb-1">
                        {isSpringTraining(team) ? 'Regular Season Record' : 'Record'}
                      </div>
                      <div
                        class:list={[
                          'text-lg font-bold',
                          team.config?.accentText || 'text-neutral-900 dark:text-white',
                        ]}
                      >
                        {team.record?.wins}-{team.record?.losses}
                      </div>
                    </div>

                    {/* Standings */}
                    <div class="rounded-lg bg-neutral-50 dark:bg-neutral-700/50 p-3">
                      <div class="text-xs text-neutral-700 dark:text-neutral-400 mb-1">
                        Standings
                      </div>
                      <div class="text-sm font-medium text-neutral-900 dark:text-white">
                        {team.standings?.summary ||
                          (team.standings?.divisionRank
                            ? `#${team.standings.divisionRank} in Division`
                            : 'TBD')}
                      </div>
                      {team.standings?.gamesBack && team.standings.gamesBack !== '-' && (
                        <div class="text-xs text-neutral-700 dark:text-neutral-400">
                          {team.standings.gamesBack} GB
                        </div>
                      )}
                    </div>

                    {/* Streak */}
                    <div class="rounded-lg bg-neutral-50 dark:bg-neutral-700/50 p-3">
                      <div class="text-xs text-neutral-700 dark:text-neutral-400 mb-1">Streak</div>
                      <div class="text-sm font-medium text-neutral-900 dark:text-white">
                        {getCurrentRun(team)}
                      </div>
                    </div>

                    {/* Win % */}
                    <div class="rounded-lg bg-neutral-50 dark:bg-neutral-700/50 p-3">
                      <div class="text-xs text-neutral-700 dark:text-neutral-400 mb-1">Win %</div>
                      <div class="text-sm font-medium text-neutral-900 dark:text-white">
                        {getWinPct(team)}
                      </div>
                    </div>

                    {/* Games Played */}
                    <div class="rounded-lg bg-neutral-50 dark:bg-neutral-700/50 p-3">
                      <div class="text-xs text-neutral-700 dark:text-neutral-400 mb-1">Games</div>
                      <div class="text-sm font-medium text-neutral-900 dark:text-white">
                        {getGamesPlayed(team)}
                      </div>
                    </div>

                    {/* Last 5 */}
                    <div class="rounded-lg bg-neutral-50 dark:bg-neutral-700/50 p-3">
                      <div class="text-xs text-neutral-700 dark:text-neutral-400 mb-1">Last 5</div>
                      <div class="text-sm font-medium text-neutral-900 dark:text-white">
                        {getLastNRecord(team, 5)}
                      </div>
                    </div>

                    {/* Recent Form */}
                    <div class="rounded-lg bg-neutral-50 dark:bg-neutral-700/50 p-3">
                      <div class="text-xs text-neutral-700 dark:text-neutral-400 mb-1">Last 10</div>
                      <div class="flex gap-0.5 flex-wrap">
                        {team.recentResults && team.recentResults.length > 0 ? (
                          team.recentResults.slice(-10).map((r: string) => (
                            <span
                              class:list={[
                                'w-5 h-5 rounded-full text-[10px] font-bold flex items-center justify-center',
                                r === 'W' ? 'bg-green-500 text-white' : 'bg-red-500 text-white',
                              ]}
                              title={r === 'W' ? 'Win' : 'Loss'}
                              aria-label={r === 'W' ? 'Win' : 'Loss'}
                            >
                              {r}
                            </span>
                          ))
                        ) : (
                          <span class="text-xs text-neutral-700 dark:text-neutral-400">
                            No games yet
                          </span>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Next / Last Game */}
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {getDisplayNextGame(team) &&
                      (() => {
                        const nextGame = getDisplayNextGame(team);
                        const watch = getWatchInfo(team.id, nextGame);
                        return (
                          <div class="flex items-start gap-3 p-3 rounded-lg border border-neutral-200 dark:border-neutral-600">
                            <div class="flex-shrink-0 mt-0.5">
                              <svg
                                class="w-4 h-4 text-green-600 dark:text-green-400"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                                stroke-width="2"
                                aria-hidden="true"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"
                                />
                              </svg>
                            </div>
                            <div>
                              <div class="text-xs font-medium text-green-700 dark:text-green-400 mb-0.5">
                                {isSpringTraining(team) ? 'Next Spring Game' : 'Next Game'}
                              </div>
                              <div class="text-sm font-medium text-neutral-900 dark:text-white">
                                {nextGame.home ? 'vs' : '@'} {nextGame.opponent}
                              </div>
                              <div class="text-xs text-neutral-700 dark:text-neutral-400">
                                {formatDate(nextGame.date)} &middot; {nextGame.time}
                              </div>
                              <div class="mt-1.5 flex items-center gap-2 flex-wrap">
                                {watch.network && (
                                  <span class="text-[11px] text-neutral-700 dark:text-neutral-400">
                                    {watch.label}: {watch.network}
                                  </span>
                                )}
                                {watch.url && (
                                  <a
                                    href={watch.url}
                                    target="_blank"
                                    rel="noopener"
                                    class="sports-watch-link"
                                  >
                                    {watch.label}
                                  </a>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })()}
                    {getDisplayLastGame(team) &&
                      (() => {
                        const lastGame = getDisplayLastGame(team);
                        return (
                          <div class="flex items-start gap-3 p-3 rounded-lg border border-neutral-200 dark:border-neutral-600">
                            <div class="flex-shrink-0 mt-0.5">
                              <svg
                                class="w-4 h-4 text-neutral-500 dark:text-neutral-400"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                                stroke-width="2"
                                aria-hidden="true"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                                />
                              </svg>
                            </div>
                            <div>
                              <div class="text-xs font-medium text-neutral-700 dark:text-neutral-400 mb-0.5">
                                {isSpringTraining(team) ? 'Last Spring Game' : 'Last Game'}
                              </div>
                              <div class="text-sm font-medium text-neutral-900 dark:text-white">
                                {lastGame.home ? 'vs' : '@'} {lastGame.opponent}
                              </div>
                              <div class="text-xs text-neutral-700 dark:text-neutral-400">
                                {formatDate(lastGame.date)} &middot;
                                <span
                                  class:list={[
                                    'font-medium',
                                    lastGame.result?.startsWith('W')
                                      ? 'text-green-600 dark:text-green-400'
                                      : 'text-red-600 dark:text-red-400',
                                  ]}
                                >
                                  {lastGame.result}
                                </span>
                              </div>
                            </div>
                          </div>
                        );
                      })()}
                    {!getDisplayNextGame(team) && !getDisplayLastGame(team) && (
                      <div class="col-span-full p-3 rounded-lg bg-neutral-50 dark:bg-neutral-700/50 text-sm text-neutral-700 dark:text-neutral-400 text-center">
                        No scheduled games
                      </div>
                    )}
                  </div>

                  {/* Action links */}
                  <div class="mt-4 pt-4 border-t border-neutral-200 dark:border-neutral-700 flex flex-wrap gap-2">
                    <a href={`/sports/${team.id}`} class="sports-link-chip">
                      Team page
                    </a>
                    <a
                      href={TEAM_LINKS[team.id]?.schedule || '#'}
                      target="_blank"
                      rel="noopener"
                      class="sports-link-chip"
                    >
                      Schedule
                    </a>
                    <a
                      href={TEAM_LINKS[team.id]?.standings || '#'}
                      target="_blank"
                      rel="noopener"
                      class="sports-link-chip"
                    >
                      Standings
                    </a>
                    <a
                      href={TEAM_LINKS[team.id]?.news || '#'}
                      target="_blank"
                      rel="noopener"
                      class="sports-link-chip"
                    >
                      Team News
                    </a>
                  </div>
                </div>
              </details>
            </article>
          ))
        }
      </div>
    </section>

    {/* No teams fallback */}
    {
      orderedTeams.length === 0 && (
        <div class="text-center py-12 text-neutral-700 dark:text-neutral-400">
          <p class="text-lg mb-2">Sports data is currently unavailable.</p>
          <p class="text-sm">Data updates every 3 hours. Check back soon.</p>
        </div>
      )
    }

    <!-- Attribution -->
    <div class="text-center text-xs text-neutral-700 dark:text-neutral-400 mt-8">
      {
        generated && (
          <p class="mb-1">
            Last updated:{' '}
            {generated.toLocaleDateString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric',
            })}{' '}
            at {generated.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
          </p>
        )
      }
      <p>Data from ESPN and MLB Stats API. Updated every 3 hours.</p>
    </div>
  </main>

  <script>
    // Keep all team panels open/locked.
    document.querySelectorAll('.sports-team-accordion[data-locked="true"]').forEach((detailsEl) => {
      const summary = detailsEl.querySelector('summary');
      if (!summary) return;
      summary.addEventListener('click', (e) => {
        e.preventDefault();
      });
      summary.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
        }
      });
      detailsEl.open = true;
    });
  </script>
  <style>
    .sports-hero {
      border: 1px solid var(--color-neutral-200, #e2e5ea);
      border-radius: 1rem;
      background:
        radial-gradient(circle at 84% 12%, rgba(91, 163, 201, 0.16), transparent 42%),
        linear-gradient(140deg, #ffffff 0%, #f7fafc 58%, #f4f8fb 100%);
      padding: 1.5rem 1rem 1.1rem;
    }

    :global(.dark) .sports-hero {
      border-color: var(--color-neutral-700, #3b3f47);
      background:
        radial-gradient(circle at 84% 12%, rgba(91, 163, 201, 0.2), transparent 45%),
        linear-gradient(140deg, #1a2433 0%, #182230 56%, #151e2a 100%);
    }

    .sports-stat-card {
      border: 1px solid var(--color-neutral-200, #e2e5ea);
      border-radius: 0.75rem;
      background: #fff;
      padding: 0.75rem 0.9rem;
    }

    :global(.dark) .sports-stat-card {
      border-color: var(--color-neutral-700, #3b3f47);
      background: var(--color-neutral-800, #1a2433);
    }

    .sports-stat-label {
      font-size: 0.72rem;
      color: var(--color-neutral-600, #4a5060);
      margin-bottom: 0.2rem;
    }

    :global(.dark) .sports-stat-label {
      color: var(--color-neutral-400, #8a92a1);
    }

    .sports-stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-neutral-900, #0f1720);
      line-height: 1.1;
    }

    :global(.dark) .sports-stat-value {
      color: #fff;
    }

    .sports-link-chip {
      border: 1px solid var(--color-neutral-200, #e2e5ea);
      border-radius: 9999px;
      padding: 0.3rem 0.7rem;
      font-size: 0.73rem;
      font-weight: 600;
      color: var(--color-neutral-700, #3b3f47);
      text-decoration: none;
      transition:
        border-color 0.2s ease,
        color 0.2s ease,
        background-color 0.2s ease;
    }

    .sports-link-chip:hover {
      border-color: var(--color-primary-400, #337fa6);
      color: var(--color-primary-700, #1a4f6e);
      background: var(--color-primary-50, #edf5f9);
    }

    :global(.dark) .sports-link-chip {
      border-color: var(--color-neutral-700, #3b3f47);
      color: var(--color-neutral-300, #c8cdd5);
      background: transparent;
    }

    :global(.dark) .sports-link-chip:hover {
      border-color: var(--color-primary-500, #1a6489);
      color: #fff;
      background: color-mix(in srgb, var(--theme-gradient-from) 30%, transparent);
    }

    .sports-team-summary {
      cursor: pointer;
      list-style: none;
      padding: 1rem 1.25rem 0.5rem;
    }

    .sports-team-summary-locked {
      cursor: default;
    }

    .sports-team-inactive {
      position: relative;
      isolation: isolate;
    }

    .sports-team-inactive::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(148, 163, 184, 0.22);
      pointer-events: none;
      z-index: 1;
    }

    :global(.dark) .sports-team-inactive::after {
      background: rgba(71, 85, 105, 0.38);
    }

    .sports-team-inactive > * {
      position: relative;
      z-index: 2;
    }

    .sports-team-summary::-webkit-details-marker {
      display: none;
    }

    .sports-watch-link {
      display: inline-flex;
      align-items: center;
      border: 1px solid #4f9f67;
      border-radius: 9999px;
      padding: 0.12rem 0.5rem;
      font-size: 0.69rem;
      font-weight: 700;
      color: #1e6d39;
      text-decoration: none;
      background: #ecf8ef;
      white-space: nowrap;
    }

    .sports-watch-link:hover {
      background: #dff1e5;
      color: #0f5a2c;
    }

    :global(.dark) .sports-watch-link {
      border-color: #3c7e52;
      color: #b7efc7;
      background: rgba(39, 89, 58, 0.34);
    }

    :global(.dark) .sports-watch-link:hover {
      background: rgba(39, 89, 58, 0.5);
      color: #d7f8e1;
    }
  </style>
</BaseLayout>
