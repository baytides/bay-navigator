---
import BaseLayout from '../layouts/BaseLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import fs from 'node:fs';
import path from 'node:path';

// Load sports data
const sportsDataPath = path.join(process.cwd(), 'public', 'data', 'sports-data.json');
let sportsData: any = { teams: {}, todaysGames: [] };
try {
  sportsData = JSON.parse(fs.readFileSync(sportsDataPath, 'utf8'));
} catch (e) {
  console.error('Failed to load sports data:', e);
}

const teams = sportsData.teams || {};
const todaysGames = sportsData.todaysGames || [];
const generated = sportsData.generated ? new Date(sportsData.generated) : null;

// Team display config â€” colors via Tailwind classes, no custom SVGs
const teamConfig: Record<
  string,
  { badge: string; badgeBg: string; borderColor: string; accentBg: string; accentText: string }
> = {
  warriors: {
    badge: 'NBA',
    badgeBg: 'bg-blue-700 text-yellow-300',
    borderColor: 'border-blue-600',
    accentBg: 'bg-blue-50 dark:bg-blue-900/20',
    accentText: 'text-blue-700 dark:text-blue-300',
  },
  giants: {
    badge: 'MLB',
    badgeBg: 'bg-orange-600 text-white',
    borderColor: 'border-orange-500',
    accentBg: 'bg-orange-50 dark:bg-orange-900/20',
    accentText: 'text-orange-700 dark:text-orange-300',
  },
  '49ers': {
    badge: 'NFL',
    badgeBg: 'bg-red-700 text-yellow-300',
    borderColor: 'border-red-600',
    accentBg: 'bg-red-50 dark:bg-red-900/20',
    accentText: 'text-red-700 dark:text-red-300',
  },
};

// Order teams: active season first
const teamOrder = ['warriors', 'giants', '49ers'];
const orderedTeams = teamOrder
  .filter((id) => teams[id])
  .map((id) => ({ id, ...teams[id], config: teamConfig[id] }));

function formatDate(dateStr: string): string {
  try {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  } catch {
    return dateStr;
  }
}
---

<BaseLayout
  title="Bay Area Sports - BayNavigator"
  description="Live scores, standings, and schedules for the Golden State Warriors, San Francisco Giants, and San Francisco 49ers."
>
  <main class="container mx-auto px-4 py-8 max-w-5xl" id="main-content">
    <Breadcrumb items={[{ label: 'Sports', href: '/sports' }]} />

    <!-- Hero Section -->
    <div class="text-center mb-8">
      <div
        class="inline-flex items-center justify-center w-16 h-16 bg-primary-100 dark:bg-primary-900/30 rounded-full mb-4"
        aria-hidden="true"
      >
        <svg
          class="w-8 h-8 text-primary-600 dark:text-primary-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M18.75 4.236c.982.143 1.954.317 2.916.52A6.003 6.003 0 0 1 16.27 9.728M18.75 4.236V4.5c0 2.108-.966 3.99-2.48 5.228m0 0a6.023 6.023 0 0 1-2.27.308 6.023 6.023 0 0 1-2.27-.308"
          ></path>
        </svg>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold text-neutral-900 dark:text-white mb-4">
        Bay Area Sports
      </h1>
      <p class="text-lg text-neutral-600 dark:text-neutral-300 max-w-2xl mx-auto">
        Live scores, standings, and schedules for {orderedTeams.length} Bay Area pro teams. Data updates
        every 3 hours.
      </p>
    </div>

    <!-- Today's Games Banner -->
    {
      todaysGames.length > 0 && (
        <div class="mb-8 p-4 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800">
          <div class="flex items-center gap-2 mb-2">
            <span class="relative flex h-2.5 w-2.5">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75" />
              <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500" />
            </span>
            <h2 class="font-semibold text-green-800 dark:text-green-200 text-sm">Games Today</h2>
          </div>
          <div class="space-y-2">
            {todaysGames.map((game: any) => (
              <div class="flex items-center justify-between text-sm">
                <span class="text-green-700 dark:text-green-300">
                  {game.team} vs {game.opponent}
                </span>
                <span class="text-green-600 dark:text-green-400 font-medium">
                  {game.time || game.status}
                </span>
              </div>
            ))}
          </div>
        </div>
      )
    }

    <!-- Team Cards -->
    <section aria-labelledby="teams-heading" class="mb-10">
      <h2 id="teams-heading" class="sr-only">Team Standings and Schedules</h2>
      <div class="space-y-6">
        {
          orderedTeams.map((team) => (
            <article
              class:list={[
                'bg-white dark:bg-neutral-800 rounded-xl shadow-sm border-l-4 border border-neutral-200 dark:border-neutral-700 overflow-hidden',
                team.config?.borderColor || 'border-primary-500',
              ]}
              aria-labelledby={`team-${team.id}-name`}
            >
              <div class="p-5 sm:p-6">
                {/* Header: team name + badge */}
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-3">
                    <h3
                      id={`team-${team.id}-name`}
                      class="text-xl font-bold text-neutral-900 dark:text-white"
                    >
                      {team.name}
                    </h3>
                    <span
                      class:list={[
                        'text-xs font-bold px-2 py-0.5 rounded-full',
                        team.config?.badgeBg || 'bg-neutral-600 text-white',
                      ]}
                    >
                      {team.config?.badge || team.sport}
                    </span>
                  </div>
                  {team.isPlayoffs && (
                    <span class="text-xs font-bold px-2.5 py-1 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 border border-yellow-300 dark:border-yellow-700">
                      PLAYOFFS
                    </span>
                  )}
                </div>

                {/* Stats row */}
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-5">
                  {/* Record */}
                  <div
                    class:list={[
                      'rounded-lg p-3',
                      team.config?.accentBg || 'bg-neutral-50 dark:bg-neutral-700',
                    ]}
                  >
                    <div class="text-xs text-neutral-600 dark:text-neutral-400 mb-1">Record</div>
                    <div
                      class:list={[
                        'text-lg font-bold',
                        team.config?.accentText || 'text-neutral-900 dark:text-white',
                      ]}
                    >
                      {team.record?.wins}-{team.record?.losses}
                    </div>
                  </div>

                  {/* Standings */}
                  <div class="rounded-lg bg-neutral-50 dark:bg-neutral-700/50 p-3">
                    <div class="text-xs text-neutral-600 dark:text-neutral-400 mb-1">Standings</div>
                    <div class="text-sm font-medium text-neutral-900 dark:text-white">
                      {team.standings?.summary ||
                        (team.standings?.divisionRank
                          ? `#${team.standings.divisionRank} in Division`
                          : 'TBD')}
                    </div>
                    {team.standings?.gamesBack && team.standings.gamesBack !== '-' && (
                      <div class="text-xs text-neutral-600 dark:text-neutral-400">
                        {team.standings.gamesBack} GB
                      </div>
                    )}
                  </div>

                  {/* Streak */}
                  <div class="rounded-lg bg-neutral-50 dark:bg-neutral-700/50 p-3">
                    <div class="text-xs text-neutral-600 dark:text-neutral-400 mb-1">Streak</div>
                    <div class="text-sm font-medium text-neutral-900 dark:text-white">
                      {team.streak || 'None'}
                    </div>
                  </div>

                  {/* Recent Form */}
                  <div class="rounded-lg bg-neutral-50 dark:bg-neutral-700/50 p-3">
                    <div class="text-xs text-neutral-600 dark:text-neutral-400 mb-1">Last 10</div>
                    <div class="flex gap-0.5 flex-wrap">
                      {team.recentResults && team.recentResults.length > 0 ? (
                        team.recentResults.slice(-10).map((r: string) => (
                          <span
                            class:list={[
                              'w-4 h-4 rounded-full text-[9px] font-bold flex items-center justify-center',
                              r === 'W' ? 'bg-green-500 text-white' : 'bg-red-500 text-white',
                            ]}
                            title={r === 'W' ? 'Win' : 'Loss'}
                            aria-label={r === 'W' ? 'Win' : 'Loss'}
                          >
                            {r}
                          </span>
                        ))
                      ) : (
                        <span class="text-xs text-neutral-600 dark:text-neutral-400">
                          No games yet
                        </span>
                      )}
                    </div>
                  </div>
                </div>

                {/* Next / Last Game */}
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  {team.nextGame && (
                    <div class="flex items-start gap-3 p-3 rounded-lg border border-neutral-200 dark:border-neutral-600">
                      <div class="flex-shrink-0 mt-0.5">
                        <svg
                          class="w-4 h-4 text-green-600 dark:text-green-400"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                          stroke-width="2"
                          aria-hidden="true"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"
                          />
                        </svg>
                      </div>
                      <div>
                        <div class="text-xs font-medium text-green-700 dark:text-green-400 mb-0.5">
                          Next Game
                        </div>
                        <div class="text-sm font-medium text-neutral-900 dark:text-white">
                          {team.nextGame.home ? 'vs' : '@'} {team.nextGame.opponent}
                        </div>
                        <div class="text-xs text-neutral-600 dark:text-neutral-400">
                          {formatDate(team.nextGame.date)} &middot; {team.nextGame.time}
                        </div>
                      </div>
                    </div>
                  )}
                  {team.lastGame && (
                    <div class="flex items-start gap-3 p-3 rounded-lg border border-neutral-200 dark:border-neutral-600">
                      <div class="flex-shrink-0 mt-0.5">
                        <svg
                          class="w-4 h-4 text-neutral-500 dark:text-neutral-400"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                          stroke-width="2"
                          aria-hidden="true"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                          />
                        </svg>
                      </div>
                      <div>
                        <div class="text-xs font-medium text-neutral-600 dark:text-neutral-400 mb-0.5">
                          Last Game
                        </div>
                        <div class="text-sm font-medium text-neutral-900 dark:text-white">
                          {team.lastGame.home ? 'vs' : '@'} {team.lastGame.opponent}
                        </div>
                        <div class="text-xs text-neutral-600 dark:text-neutral-400">
                          {formatDate(team.lastGame.date)} &middot;
                          <span
                            class:list={[
                              'font-medium',
                              team.lastGame.result?.startsWith('W')
                                ? 'text-green-600 dark:text-green-400'
                                : 'text-red-600 dark:text-red-400',
                            ]}
                          >
                            {team.lastGame.result}
                          </span>
                        </div>
                      </div>
                    </div>
                  )}
                  {!team.nextGame && !team.lastGame && (
                    <div class="col-span-full p-3 rounded-lg bg-neutral-50 dark:bg-neutral-700/50 text-sm text-neutral-600 dark:text-neutral-400 text-center">
                      No scheduled games
                    </div>
                  )}
                </div>
              </div>
            </article>
          ))
        }
      </div>
    </section>

    {/* No teams fallback */}
    {
      orderedTeams.length === 0 && (
        <div class="text-center py-12 text-neutral-600 dark:text-neutral-400">
          <p class="text-lg mb-2">Sports data is currently unavailable.</p>
          <p class="text-sm">Data updates every 3 hours. Check back soon.</p>
        </div>
      )
    }

    <!-- Attribution -->
    <div class="text-center text-xs text-neutral-600 dark:text-neutral-400 mt-8">
      {
        generated && (
          <p class="mb-1">
            Last updated:{' '}
            {generated.toLocaleDateString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric',
            })}{' '}
            at {generated.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
          </p>
        )
      }
      <p>Data from ESPN and MLB Stats API. Updated every 3 hours.</p>
    </div>
  </main>
</BaseLayout>
