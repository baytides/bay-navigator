---
import BaseLayout from '../layouts/BaseLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';

const mapboxToken = import.meta.env.PUBLIC_MAPBOX_TOKEN;
---

<BaseLayout
  title="Bay Area Travel Hub - BayNavigator"
  description="Real-time status, live maps, and journey planning for all Bay Area airports, transit, and traffic. BART, Caltrain, SFO, OAK, SJC, and more."
>
  <main class="container mx-auto px-4 py-8 max-w-7xl" id="main-content">
    <Breadcrumb items={[{ label: 'Travel', href: '/travel' }]} />

    <!-- Hero Section -->
    <div class="text-center mb-8">
      <div
        class="inline-flex items-center justify-center w-16 h-16 bg-primary-100 dark:bg-primary-900/30 rounded-full mb-4"
        aria-hidden="true"
      >
        <svg
          class="w-8 h-8 text-primary-600 dark:text-primary-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
          ></path>
        </svg>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold text-neutral-900 dark:text-white mb-4">
        Bay Area Travel Hub
      </h1>
      <p class="text-lg text-neutral-600 dark:text-neutral-300 max-w-2xl mx-auto">
        Real-time status and journey planning for all Bay Area airports, transit, and traffic. Live
        updates every minute.
      </p>
    </div>

    <!-- Live Status Dashboard -->
    <section aria-labelledby="status-heading" class="mb-8">
      <div class="flex items-center gap-3 mb-4">
        <div id="live-indicator" class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
        <h2 id="status-heading" class="text-xl font-semibold text-neutral-900 dark:text-white">
          Live System Status
        </h2>
        <span
          id="status-updated"
          class="text-xs bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400 px-2 py-0.5 rounded-full"
        >
          Loading...
        </span>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <!-- Airports Status Card -->
        <div
          class="bg-white dark:bg-neutral-800 rounded-lg shadow-sm border border-neutral-200 dark:border-neutral-700 p-4"
        >
          <div class="flex items-center gap-2 mb-3">
            <svg
              class="w-5 h-5 text-blue-600 dark:text-blue-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            <h3 class="font-semibold text-neutral-900 dark:text-white">Airports</h3>
          </div>
          <div id="airports-status" class="space-y-2 text-sm">
            <div class="flex items-center justify-center h-20">
              <svg class="animate-spin h-5 w-5 text-neutral-400" fill="none" viewBox="0 0 24 24">
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- Transit Status Card -->
        <div
          class="bg-white dark:bg-neutral-800 rounded-lg shadow-sm border border-neutral-200 dark:border-neutral-700 p-4"
        >
          <div class="flex items-center gap-2 mb-3">
            <svg
              class="w-5 h-5 text-teal-600 dark:text-teal-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7h8m-8 4h8m-6 4h4M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"
              ></path>
            </svg>
            <h3 class="font-semibold text-neutral-900 dark:text-white">Rail & Ferry</h3>
          </div>
          <div id="transit-status" class="space-y-2 text-sm">
            <div class="flex items-center justify-center h-20">
              <svg class="animate-spin h-5 w-5 text-neutral-400" fill="none" viewBox="0 0 24 24">
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- Traffic Status Card -->
        <div
          class="bg-white dark:bg-neutral-800 rounded-lg shadow-sm border border-neutral-200 dark:border-neutral-700 p-4"
        >
          <div class="flex items-center gap-2 mb-3">
            <svg
              class="w-5 h-5 text-orange-600 dark:text-orange-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>
            <h3 class="font-semibold text-neutral-900 dark:text-white">Traffic</h3>
          </div>
          <div id="traffic-status" class="space-y-2 text-sm">
            <div class="text-neutral-600 dark:text-neutral-400">
              <p>Real-time traffic data</p>
              <p class="text-xs mt-1">See map below for details</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Journey Planner -->
    <section
      aria-labelledby="planner-heading"
      class="mb-8 bg-gradient-to-r from-primary-50 to-blue-50 dark:from-primary-900/20 dark:to-blue-900/20 rounded-xl p-6"
    >
      <h2 id="planner-heading" class="text-xl font-semibold text-neutral-900 dark:text-white mb-4">
        Plan Your Journey
      </h2>

      <form id="journey-form" role="search" aria-label="Journey planner" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <!-- From -->
          <div>
            <label
              for="journey-from"
              class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1"
            >
              From
            </label>
            <input
              id="journey-from"
              type="text"
              placeholder="Current location, station, or address"
              autocomplete="off"
              class="w-full px-4 py-2 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-800 text-neutral-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
              aria-describedby="from-help"
            />
            <span id="from-help" class="sr-only">
              Type to search for stations, airports, or addresses
            </span>
          </div>

          <!-- To -->
          <div>
            <label
              for="journey-to"
              class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1"
            >
              To
            </label>
            <input
              id="journey-to"
              type="text"
              placeholder="Destination, station, or address"
              autocomplete="off"
              class="w-full px-4 py-2 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-800 text-neutral-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
              aria-describedby="to-help"
            />
            <span id="to-help" class="sr-only">
              Type to search for stations, airports, or addresses
            </span>
          </div>
        </div>

        <div class="flex flex-wrap gap-4 items-end">
          <!-- When -->
          <div class="flex gap-2 items-center">
            <input
              type="radio"
              id="depart-now"
              name="depart-time"
              value="now"
              checked
              class="w-4 h-4 text-primary-600 focus:ring-primary-500"
            />
            <label for="depart-now" class="text-sm text-neutral-700 dark:text-neutral-300">
              Now
            </label>

            <input
              type="radio"
              id="depart-later"
              name="depart-time"
              value="later"
              class="w-4 h-4 text-primary-600 focus:ring-primary-500 ml-4"
            />
            <label for="depart-later" class="text-sm text-neutral-700 dark:text-neutral-300">
              Depart at
            </label>
            <input
              type="time"
              id="depart-time-input"
              disabled
              class="px-2 py-1 text-sm border border-neutral-300 dark:border-neutral-600 rounded bg-white dark:bg-neutral-800 text-neutral-900 dark:text-white disabled:opacity-50"
            />
          </div>

          <!-- Mode -->
          <div class="flex gap-3 items-center">
            <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Mode:</span>
            <label class="flex items-center gap-1">
              <input type="checkbox" checked class="w-4 h-4 text-primary-600 rounded" />
              <span class="text-sm text-neutral-700 dark:text-neutral-300">Transit</span>
            </label>
            <label class="flex items-center gap-1">
              <input type="checkbox" checked class="w-4 h-4 text-primary-600 rounded" />
              <span class="text-sm text-neutral-700 dark:text-neutral-300">Drive</span>
            </label>
          </div>

          <!-- Submit -->
          <button
            type="submit"
            class="ml-auto px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
          >
            <span class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              Plan Trip
            </span>
          </button>
        </div>
      </form>

      <!-- Results -->
      <div
        id="journey-results"
        role="region"
        aria-label="Journey planning results"
        aria-live="polite"
        class="mt-6 hidden"
      >
        <h3 class="text-lg font-semibold text-neutral-900 dark:text-white mb-3">
          Your Route Options
        </h3>
        <div id="journey-results-content" class="space-y-3">
          <!-- Results will be inserted here -->
        </div>
      </div>
    </section>

    <!-- Interactive Map -->
    <section aria-labelledby="map-heading" class="mb-8">
      <h2 id="map-heading" class="text-xl font-semibold text-neutral-900 dark:text-white mb-4">
        Live Map with Traffic
      </h2>
      <div
        id="map"
        class="w-full h-[600px] rounded-xl border border-neutral-200 dark:border-neutral-700 shadow-sm"
        role="application"
        aria-label="Interactive map showing Bay Area airports, transit, and traffic"
      >
        <div class="flex items-center justify-center h-full bg-neutral-100 dark:bg-neutral-800">
          <p class="text-neutral-500">Loading map...</p>
        </div>
      </div>
    </section>

    <!-- Quick Access Tabs -->
    <section aria-labelledby="details-heading" class="mb-8">
      <div
        role="tablist"
        aria-label="Travel information categories"
        class="flex gap-2 mb-4 border-b border-neutral-200 dark:border-neutral-700"
      >
        <button
          role="tab"
          aria-selected="true"
          aria-controls="airports-panel"
          id="airports-tab"
          class="tab-button px-4 py-2 font-medium border-b-2 border-primary-600 text-primary-600 dark:text-primary-400"
        >
          Airports
        </button>
        <button
          role="tab"
          aria-selected="false"
          aria-controls="rail-panel"
          id="rail-tab"
          class="tab-button px-4 py-2 font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white"
        >
          Rail & Ferry
        </button>
        <button
          role="tab"
          aria-selected="false"
          aria-controls="bus-panel"
          id="bus-tab"
          class="tab-button px-4 py-2 font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white"
        >
          Bus
        </button>
      </div>

      <!-- Tab Panels -->
      <div id="airports-panel" role="tabpanel" aria-labelledby="airports-tab" class="tab-panel">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Airport cards will be inserted here dynamically -->
        </div>
      </div>

      <div id="rail-panel" role="tabpanel" aria-labelledby="rail-tab" class="tab-panel hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Rail cards will be inserted here dynamically -->
        </div>
      </div>

      <div id="bus-panel" role="tabpanel" aria-labelledby="bus-tab" class="tab-panel hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Bus cards will be inserted here dynamically -->
        </div>
      </div>
    </section>

    <!-- Attribution -->
    <p class="text-xs text-neutral-500 dark:text-neutral-400 text-center">
      Real-time data from{' '}
      <a
        href="https://511.org"
        target="_blank"
        rel="noopener noreferrer"
        class="text-primary-600 dark:text-primary-400 hover:underline"
      >
        511.org
      </a>,{' '}
      <a
        href="https://www.faa.gov/"
        target="_blank"
        rel="noopener noreferrer"
        class="text-primary-600 dark:text-primary-400 hover:underline"
      >
        FAA
      </a>, and{' '}
      <a
        href="https://www.mapbox.com"
        target="_blank"
        rel="noopener noreferrer"
        class="text-primary-600 dark:text-primary-400 hover:underline"
      >
        Mapbox
      </a>. Updates every 60 seconds.
    </p>
  </main>

  <!-- Screen reader announcements -->
  <div id="sr-announcements" role="status" aria-live="polite" class="sr-only"></div>

  <script>
    import mapboxgl from 'mapbox-gl';
    import 'mapbox-gl/dist/mapbox-gl.css';

    // Get Mapbox token
    const mapboxToken = import.meta.env.PUBLIC_MAPBOX_TOKEN;

    if (!mapboxToken) {
      console.error('[Travel] Missing MAPBOX_TOKEN');
    } else {
      mapboxgl.accessToken = mapboxToken;
    }

    // Initialize map
    let map: mapboxgl.Map | null = null;

    function initMap() {
      if (!mapboxToken) return;

      try {
        map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/navigation-day-v1', // Traffic-aware style
          center: [-122.4194, 37.7749], // San Francisco
          zoom: 9,
        });

        map.on('load', () => {
          console.log('[Travel] Map loaded successfully');

          // Add traffic layer
          map!.addLayer({
            id: 'traffic',
            type: 'line',
            source: {
              type: 'vector',
              url: 'mapbox://mapbox.mapbox-traffic-v1',
            },
            'source-layer': 'traffic',
            paint: {
              'line-color': [
                'case',
                ['==', ['get', 'congestion'], 'low'],
                '#0d7c3a',
                ['==', ['get', 'congestion'], 'moderate'],
                '#c77700',
                ['==', ['get', 'congestion'], 'heavy'],
                '#d32f2f',
                '#b71c1c', // severe
              ],
              'line-width': 3,
            },
          });

          // Add navigation controls
          map!.addControl(new mapboxgl.NavigationControl());

          // Add airport markers
          addAirportMarkers();
        });
      } catch (error) {
        console.error('[Travel] Map initialization failed:', error);
      }
    }

    // Add airport markers to map
    function addAirportMarkers() {
      if (!map) return;

      const airports = [
        {
          code: 'SFO',
          name: 'San Francisco International',
          coords: [-122.3789, 37.6213] as [number, number],
          color: '#0ea5e9',
        },
        {
          code: 'OAK',
          name: 'Oakland International',
          coords: [-122.2208, 37.7116] as [number, number],
          color: '#8b5cf6',
        },
        {
          code: 'SJC',
          name: 'San Jose International',
          coords: [-121.929, 37.3639] as [number, number],
          color: '#ec4899',
        },
      ];

      airports.forEach((airport) => {
        // Create marker element
        const el = document.createElement('div');
        el.className = 'airport-marker';
        el.style.width = '32px';
        el.style.height = '32px';
        el.style.backgroundColor = airport.color;
        el.style.borderRadius = '50%';
        el.style.border = '3px solid white';
        el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
        el.style.cursor = 'pointer';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.style.fontWeight = 'bold';
        el.style.fontSize = '10px';
        el.style.color = 'white';
        el.textContent = airport.code;
        el.setAttribute('role', 'button');
        el.setAttribute('aria-label', `${airport.name} airport marker`);

        // Create popup
        const popup = new mapboxgl.Popup({ offset: 25, closeButton: true }).setHTML(`
          <div style="padding: 4px;">
            <h3 style="font-weight: 600; margin: 0 0 4px 0; font-size: 14px;">${airport.code}</h3>
            <p style="margin: 0 0 8px 0; font-size: 12px; color: #666;">${airport.name}</p>
            <div id="airport-status-${airport.code}" style="font-size: 12px;">
              <div style="display: flex; align-items: center; gap: 4px;">
                <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></span>
                <span>Loading status...</span>
              </div>
            </div>
          </div>
        `);

        // Add marker to map
        new mapboxgl.Marker(el).setLngLat(airport.coords).setPopup(popup).addTo(map!);

        // Fetch and update popup status when opened
        popup.on('open', () => {
          updateAirportPopupStatus(airport.code);
        });
      });
    }

    // Update airport popup status (called when popup opens)
    async function updateAirportPopupStatus(airportCode: string) {
      const statusEl = document.getElementById(`airport-status-${airportCode}`);
      if (!statusEl) return;

      try {
        // For now, use placeholder data
        // TODO: Integrate with FAA API when available
        const status = {
          delay: false,
          reason: null,
        };

        const statusIndicator = document.createElement('div');
        statusIndicator.style.display = 'flex';
        statusIndicator.style.alignItems = 'center';
        statusIndicator.style.gap = '4px';

        const dot = document.createElement('span');
        dot.style.display = 'inline-block';
        dot.style.width = '8px';
        dot.style.height = '8px';
        dot.style.borderRadius = '50%';
        dot.style.background = status.delay ? '#f59e0b' : '#10b981';

        const text = document.createElement('span');
        text.textContent = status.delay ? `Delays: ${status.reason}` : 'Normal operations';

        statusIndicator.appendChild(dot);
        statusIndicator.appendChild(text);
        statusEl.innerHTML = '';
        statusEl.appendChild(statusIndicator);
      } catch (error) {
        console.error(`[Travel] Failed to load ${airportCode} status:`, error);
        const errorText = document.createElement('span');
        errorText.style.color = '#ef4444';
        errorText.textContent = 'Status unavailable';
        statusEl.innerHTML = '';
        statusEl.appendChild(errorText);
      }
    }

    // Tab switching
    function initTabs() {
      const tabs = document.querySelectorAll('[role="tab"]');
      const panels = document.querySelectorAll('[role="tabpanel"]');

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const target = tab.getAttribute('aria-controls');

          // Update tabs
          tabs.forEach((t) => {
            t.setAttribute('aria-selected', 'false');
            t.classList.remove('border-primary-600', 'text-primary-600', 'dark:text-primary-400');
            t.classList.add('border-transparent', 'text-neutral-600', 'dark:text-neutral-400');
          });

          tab.setAttribute('aria-selected', 'true');
          tab.classList.add('border-primary-600', 'text-primary-600', 'dark:text-primary-400');
          tab.classList.remove('border-transparent', 'text-neutral-600', 'dark:text-neutral-400');

          // Update panels
          panels.forEach((p) => p.classList.add('hidden'));
          const targetPanel = document.getElementById(target!);
          if (targetPanel) {
            targetPanel.classList.remove('hidden');
          }
        });
      });
    }

    // Journey planner form
    function initJourneyPlanner() {
      const form = document.getElementById('journey-form') as HTMLFormElement;
      const departLaterRadio = document.getElementById('depart-later') as HTMLInputElement;
      const departTimeInput = document.getElementById('depart-time-input') as HTMLInputElement;

      // Enable/disable time input
      document.querySelectorAll('input[name="depart-time"]').forEach((radio) => {
        radio.addEventListener('change', () => {
          departTimeInput.disabled = !departLaterRadio.checked;
        });
      });

      // Handle form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await planJourney();
      });
    }

    // Plan journey using Mapbox Directions API
    async function planJourney() {
      try {
        const fromInput = document.getElementById('journey-from') as HTMLInputElement;
        const toInput = document.getElementById('journey-to') as HTMLInputElement;
        const resultsContainer = document.getElementById('journey-results');

        if (!fromInput || !toInput || !resultsContainer) return;

        const from = fromInput.value.trim();
        const to = toInput.value.trim();

        if (!from || !to) {
          showJourneyError('Please enter both origin and destination');
          return;
        }

        // Show loading state
        resultsContainer.classList.remove('hidden');
        resultsContainer.innerHTML = '';
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'text-center py-4';
        const loadingText = document.createElement('p');
        loadingText.className = 'text-neutral-600 dark:text-neutral-400';
        loadingText.textContent = 'Planning your journey...';
        loadingDiv.appendChild(loadingText);
        resultsContainer.appendChild(loadingDiv);

        // Geocode origin and destination
        const [fromCoords, toCoords] = await Promise.all([
          geocodeLocation(from),
          geocodeLocation(to),
        ]);

        if (!fromCoords || !toCoords) {
          showJourneyError('Could not find one or more locations. Please try again.');
          return;
        }

        // Get driving route
        const drivingRoute = await getDirections(fromCoords, toCoords, 'driving-traffic');

        // Display results
        displayJourneyResults(drivingRoute, from, to);

        // Update map with route
        if (map && drivingRoute) {
          displayRouteOnMap(drivingRoute);
        }
      } catch (error) {
        console.error('[Travel] Journey planning failed:', error);
        showJourneyError('Failed to plan journey. Please try again.');
      }
    }

    // Geocode a location using Mapbox Geocoding API
    async function geocodeLocation(query: string): Promise<[number, number] | null> {
      try {
        const response = await fetch(
          `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxToken}&proximity=-122.4194,37.7749&bbox=-123.5,36.5,-121.0,38.5`
        );

        if (!response.ok) return null;

        const data = await response.json();
        if (data.features && data.features.length > 0) {
          return data.features[0].center as [number, number];
        }

        return null;
      } catch (error) {
        console.error('[Travel] Geocoding failed:', error);
        return null;
      }
    }

    // Get directions using Mapbox Directions API
    async function getDirections(
      from: [number, number],
      to: [number, number],
      profile: string
    ): Promise<any> {
      try {
        const response = await fetch(
          `https://api.mapbox.com/directions/v5/mapbox/${profile}/${from[0]},${from[1]};${to[0]},${to[1]}?geometries=geojson&steps=true&access_token=${mapboxToken}`
        );

        if (!response.ok) return null;

        const data = await response.json();
        if (data.routes && data.routes.length > 0) {
          return data.routes[0];
        }

        return null;
      } catch (error) {
        console.error('[Travel] Directions API failed:', error);
        return null;
      }
    }

    // Display journey results
    function displayJourneyResults(route: any, from: string, to: string) {
      const resultsContainer = document.getElementById('journey-results');
      if (!resultsContainer || !route) return;

      resultsContainer.innerHTML = '';
      resultsContainer.classList.remove('hidden');

      // Header
      const header = document.createElement('h3');
      header.className = 'text-lg font-semibold text-neutral-900 dark:text-white mb-3';
      header.textContent = 'Your Route Options';

      // Route card
      const card = document.createElement('div');
      card.className =
        'bg-white dark:bg-neutral-800 rounded-lg border border-neutral-200 dark:border-neutral-700 p-4 shadow-sm';

      // Route header
      const routeHeader = document.createElement('div');
      routeHeader.className = 'flex items-start justify-between mb-3';

      const routeInfo = document.createElement('div');
      const routeName = document.createElement('h4');
      routeName.className = 'font-semibold text-neutral-900 dark:text-white';
      routeName.textContent = 'Driving Route';

      const routeDesc = document.createElement('p');
      routeDesc.className = 'text-sm text-neutral-600 dark:text-neutral-400 mt-1';
      routeDesc.textContent = `${from} → ${to}`;

      routeInfo.appendChild(routeName);
      routeInfo.appendChild(routeDesc);

      // Duration and distance
      const stats = document.createElement('div');
      stats.className = 'text-right';

      const duration = document.createElement('p');
      duration.className = 'text-lg font-bold text-primary-600 dark:text-primary-400';
      duration.textContent = formatDuration(route.duration);

      const distance = document.createElement('p');
      distance.className = 'text-sm text-neutral-600 dark:text-neutral-400';
      distance.textContent = formatDistance(route.distance);

      stats.appendChild(duration);
      stats.appendChild(distance);

      routeHeader.appendChild(routeInfo);
      routeHeader.appendChild(stats);

      // Steps
      if (route.legs && route.legs[0] && route.legs[0].steps) {
        const stepsContainer = document.createElement('div');
        stepsContainer.className = 'mt-4 pt-4 border-t border-neutral-200 dark:border-neutral-700';

        const stepsHeader = document.createElement('p');
        stepsHeader.className = 'text-sm font-medium text-neutral-900 dark:text-white mb-2';
        stepsHeader.textContent = 'Turn-by-turn directions:';

        const stepsList = document.createElement('ol');
        stepsList.className = 'space-y-2 text-sm text-neutral-700 dark:text-neutral-300';

        route.legs[0].steps.slice(0, 5).forEach((step: any, index: number) => {
          const stepItem = document.createElement('li');
          stepItem.textContent = `${index + 1}. ${step.maneuver.instruction}`;
          stepsList.appendChild(stepItem);
        });

        if (route.legs[0].steps.length > 5) {
          const moreSteps = document.createElement('li');
          moreSteps.className = 'text-neutral-500 dark:text-neutral-500';
          moreSteps.textContent = `... and ${route.legs[0].steps.length - 5} more steps`;
          stepsList.appendChild(moreSteps);
        }

        stepsContainer.appendChild(stepsHeader);
        stepsContainer.appendChild(stepsList);
        card.appendChild(routeHeader);
        card.appendChild(stepsContainer);
      } else {
        card.appendChild(routeHeader);
      }

      resultsContainer.appendChild(header);
      resultsContainer.appendChild(card);
    }

    // Display route on map
    function displayRouteOnMap(route: any) {
      if (!map || !route.geometry) return;

      // Remove existing route if any
      if (map.getSource('route')) {
        map.removeLayer('route');
        map.removeSource('route');
      }

      // Add route source
      map.addSource('route', {
        type: 'geojson',
        data: {
          type: 'Feature',
          properties: {},
          geometry: route.geometry,
        },
      });

      // Add route layer
      map.addLayer({
        id: 'route',
        type: 'line',
        source: 'route',
        layout: {
          'line-join': 'round',
          'line-cap': 'round',
        },
        paint: {
          'line-color': '#2563eb',
          'line-width': 4,
        },
      });

      // Fit map to route bounds
      const coordinates = route.geometry.coordinates;
      const bounds = coordinates.reduce(
        (bounds: any, coord: any) => {
          return bounds.extend(coord);
        },
        new mapboxgl.LngLatBounds(coordinates[0], coordinates[0])
      );

      map.fitBounds(bounds, {
        padding: 50,
      });
    }

    // Show journey error
    function showJourneyError(message: string) {
      const resultsContainer = document.getElementById('journey-results');
      if (!resultsContainer) return;

      resultsContainer.classList.remove('hidden');
      resultsContainer.innerHTML = '';

      const errorDiv = document.createElement('div');
      errorDiv.className =
        'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4';

      const errorText = document.createElement('p');
      errorText.className = 'text-sm text-red-700 dark:text-red-400';
      errorText.textContent = message;

      errorDiv.appendChild(errorText);
      resultsContainer.appendChild(errorDiv);
    }

    // Format duration in seconds to human readable
    function formatDuration(seconds: number): string {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);

      if (hours > 0) {
        return `${hours}h ${minutes}m`;
      }
      return `${minutes}m`;
    }

    // Format distance in meters to human readable
    function formatDistance(meters: number): string {
      const miles = meters / 1609.34;
      return `${miles.toFixed(1)} mi`;
    }

    // Load live status data
    async function loadLiveStatus() {
      try {
        console.log('[Travel] Loading live status...');

        // Fetch transit data from 511.org API
        await loadTransitStatus();

        // Fetch airport status
        await loadAirportStatus();

        // Update timestamp
        const statusUpdated = document.getElementById('status-updated');
        if (statusUpdated) {
          statusUpdated.textContent = `Updated ${new Date().toLocaleTimeString()}`;
        }
      } catch (error) {
        console.error('[Travel] Failed to load status:', error);
      }
    }

    // Load transit status from 511.org
    async function loadTransitStatus() {
      try {
        const response = await fetch('/api/transit-live');

        if (!response.ok) {
          throw new Error(`Transit API error: ${response.status}`);
        }

        const data = await response.json();
        const transitStatus = document.getElementById('transit-status');

        if (!transitStatus) return;

        // Count alerts by agency
        const alertCounts: Record<string, number> = {};
        if (data.alerts && data.alerts.entity) {
          data.alerts.entity.forEach((entity: any) => {
            if (entity.alert && entity.alert.informed_entity) {
              entity.alert.informed_entity.forEach((ie: any) => {
                if (ie.route_id) {
                  const agencyPrefix = ie.route_id.substring(0, 2);
                  alertCounts[agencyPrefix] = (alertCounts[agencyPrefix] || 0) + 1;
                }
              });
            }
          });
        }

        // Display all major Bay Area transit agencies with status
        const agencies = [
          { code: 'BA', name: 'BART' },
          { code: 'CT', name: 'Caltrain' },
          { code: 'SF', name: 'Muni' },
          { code: 'AC', name: 'AC Transit' },
          { code: 'SC', name: 'VTA' },
          { code: 'SM', name: 'SamTrans' },
          { code: 'GG', name: 'Golden Gate Transit' },
          { code: 'GF', name: 'Golden Gate Ferry' },
          { code: 'SB', name: 'SF Bay Ferry' },
          { code: 'CC', name: 'County Connection' },
          { code: 'MA', name: 'Marin Transit' },
          { code: 'ST', name: 'SolTrans' },
          { code: 'WC', name: 'WestCat' },
          { code: 'FS', name: 'Fairfield Suisun Transit' },
          { code: '3D', name: 'Tri Delta Transit' },
          { code: 'UC', name: 'Union City Transit' },
          { code: 'EM', name: 'Emery Go-Round' },
          { code: 'WH', name: 'Wheels' },
          { code: 'DE', name: 'Dumbarton Express' },
          { code: 'SO', name: 'Sonoma County Transit' },
          { code: 'SR', name: 'Santa Rosa CityBus' },
          { code: 'SA', name: 'SMART' },
          { code: 'PE', name: 'Petaluma Transit' },
          { code: 'VN', name: 'Vine' },
          { code: 'AM', name: 'Capitol Corridor' },
          { code: 'CE', name: 'ACE' },
        ];

        // Clear existing content
        transitStatus.innerHTML = '';

        let totalAlerts = 0;

        agencies.forEach((agency) => {
          const count = alertCounts[agency.code] || 0;
          totalAlerts += count;

          const row = document.createElement('div');
          row.className = 'flex items-center justify-between';

          const nameSpan = document.createElement('span');
          nameSpan.className = 'text-neutral-700 dark:text-neutral-300';
          nameSpan.textContent = agency.name;

          const statusSpan = document.createElement('span');
          statusSpan.className = 'text-xs';

          if (count > 0) {
            statusSpan.className += ' text-yellow-600 dark:text-yellow-400';
            statusSpan.textContent = `${count} alert${count > 1 ? 's' : ''}`;
          } else {
            statusSpan.className += ' text-green-600 dark:text-green-400';
            statusSpan.textContent = 'On time';
          }

          row.appendChild(nameSpan);
          row.appendChild(statusSpan);
          transitStatus.appendChild(row);
        });

        if (totalAlerts === 0) {
          transitStatus.innerHTML = '';
          const allClearDiv = document.createElement('div');
          allClearDiv.className = 'text-center py-2';
          const allClearSpan = document.createElement('span');
          allClearSpan.className = 'text-green-600 dark:text-green-400';
          allClearSpan.textContent = '✓ All services normal';
          allClearDiv.appendChild(allClearSpan);
          transitStatus.appendChild(allClearDiv);
        }
      } catch (error) {
        console.error('[Travel] Failed to load transit status:', error);
        const transitStatus = document.getElementById('transit-status');
        if (transitStatus) {
          transitStatus.innerHTML = '';
          const errorDiv = document.createElement('div');
          errorDiv.className = 'text-neutral-500 text-xs';
          errorDiv.textContent = 'Unable to load transit data';
          transitStatus.appendChild(errorDiv);
        }
      }
    }

    // Load airport status
    async function loadAirportStatus() {
      try {
        const airports = [
          { code: 'SFO', name: 'SFO' },
          { code: 'OAK', name: 'OAK' },
          { code: 'SJC', name: 'SJC' },
        ];

        const airportsStatus = document.getElementById('airports-status');
        if (!airportsStatus) return;

        // Clear existing content
        airportsStatus.innerHTML = '';

        airports.forEach((airport) => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between';

          const nameSpan = document.createElement('span');
          nameSpan.className = 'text-neutral-700 dark:text-neutral-300';
          nameSpan.textContent = airport.name;

          const statusSpan = document.createElement('span');
          statusSpan.className = 'text-green-600 dark:text-green-400 text-xs';
          statusSpan.textContent = 'Normal';

          row.appendChild(nameSpan);
          row.appendChild(statusSpan);
          airportsStatus.appendChild(row);
        });
      } catch (error) {
        console.error('[Travel] Failed to load airport status:', error);
      }
    }

    // Populate airport tab panel
    function populateAirportsPanel() {
      const panel = document.getElementById('airports-panel');
      if (!panel) return;

      const container = panel.querySelector('.grid');
      if (!container) return;

      const airports = [
        {
          code: 'SFO',
          name: 'San Francisco International',
          location: 'San Francisco',
          description: 'Major international hub serving the Bay Area',
          parking: 'Short-term and long-term lots available',
          transit: 'BART direct service available',
          website: 'https://www.flysfo.com',
          phone: '(650) 821-8211',
        },
        {
          code: 'OAK',
          name: 'Oakland International',
          location: 'Oakland',
          description: 'Conveniently located East Bay airport',
          parking: 'Economy and premium parking options',
          transit: 'BART + AirBART shuttle connection',
          website: 'https://www.oaklandairport.com',
          phone: '(510) 563-3300',
        },
        {
          code: 'SJC',
          name: 'San Jose International',
          location: 'San Jose',
          description: 'Gateway to Silicon Valley and South Bay',
          parking: 'Multiple parking structures available',
          transit: 'VTA light rail and bus access',
          website: 'https://www.flysanjose.com',
          phone: '(408) 392-3600',
        },
      ];

      container.innerHTML = '';

      airports.forEach((airport) => {
        const card = document.createElement('div');
        card.className =
          'bg-white dark:bg-neutral-800 rounded-lg border border-neutral-200 dark:border-neutral-700 p-6 shadow-sm hover:shadow-md transition-shadow';

        // Header
        const header = document.createElement('div');
        header.className = 'flex items-start justify-between mb-4';

        const headerLeft = document.createElement('div');
        const code = document.createElement('h3');
        code.className = 'text-2xl font-bold text-primary-600 dark:text-primary-400';
        code.textContent = airport.code;

        const name = document.createElement('p');
        name.className = 'text-sm text-neutral-600 dark:text-neutral-400 mt-1';
        name.textContent = airport.name;

        headerLeft.appendChild(code);
        headerLeft.appendChild(name);

        // Status badge
        const statusBadge = document.createElement('div');
        statusBadge.id = `airport-card-status-${airport.code}`;
        statusBadge.className =
          'px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300';
        statusBadge.textContent = 'Normal';

        header.appendChild(headerLeft);
        header.appendChild(statusBadge);

        // Description
        const desc = document.createElement('p');
        desc.className = 'text-sm text-neutral-700 dark:text-neutral-300 mb-4';
        desc.textContent = airport.description;

        // Info list
        const infoList = document.createElement('dl');
        infoList.className = 'text-sm space-y-2';

        const infos = [
          { label: 'Location', value: airport.location },
          { label: 'Parking', value: airport.parking },
          { label: 'Transit', value: airport.transit },
        ];

        infos.forEach((info) => {
          const wrapper = document.createElement('div');
          const dt = document.createElement('dt');
          dt.className = 'inline font-medium text-neutral-900 dark:text-white';
          dt.textContent = `${info.label}: `;

          const dd = document.createElement('dd');
          dd.className = 'inline text-neutral-600 dark:text-neutral-400';
          dd.textContent = info.value;

          wrapper.appendChild(dt);
          wrapper.appendChild(dd);
          infoList.appendChild(wrapper);
        });

        // Links
        const links = document.createElement('div');
        links.className =
          'flex gap-3 mt-4 pt-4 border-t border-neutral-200 dark:border-neutral-700';

        const websiteLink = document.createElement('a');
        websiteLink.href = airport.website;
        websiteLink.target = '_blank';
        websiteLink.rel = 'noopener noreferrer';
        websiteLink.className = 'text-sm text-primary-600 dark:text-primary-400 hover:underline';
        websiteLink.textContent = 'Website';

        const phoneLink = document.createElement('a');
        phoneLink.href = `tel:${airport.phone.replace(/\D/g, '')}`;
        phoneLink.className = 'text-sm text-primary-600 dark:text-primary-400 hover:underline';
        phoneLink.textContent = airport.phone;

        links.appendChild(websiteLink);
        links.appendChild(phoneLink);

        // Assemble card
        card.appendChild(header);
        card.appendChild(desc);
        card.appendChild(infoList);
        card.appendChild(links);
        container.appendChild(card);
      });
    }

    // Populate rail & ferry tab panel
    function populateRailPanel() {
      const panel = document.getElementById('rail-panel');
      if (!panel) return;

      const container = panel.querySelector('.grid');
      if (!container) return;

      const agencies = [
        {
          name: 'BART',
          fullName: 'Bay Area Rapid Transit',
          description: 'Regional rail system connecting SF, East Bay, and Peninsula',
          website: 'https://www.bart.gov',
          phone: '(510) 465-2278',
        },
        {
          name: 'Caltrain',
          fullName: 'Caltrain',
          description: 'Electrified commuter rail serving SF to San Jose corridor',
          website: 'https://www.caltrain.com',
          phone: '1-800-660-4287',
        },
        {
          name: 'Capitol Corridor',
          fullName: 'Capitol Corridor',
          description: 'Intercity rail connecting San Jose to Sacramento via Oakland',
          website: 'https://www.capitolcorridor.org',
          phone: '1-877-974-2457',
        },
        {
          name: 'ACE',
          fullName: 'Altamont Corridor Express',
          description: 'Commuter rail connecting Stockton to San Jose',
          website: 'https://www.acerail.com',
          phone: '(209) 644-4545',
        },
        {
          name: 'SMART',
          fullName: 'Sonoma-Marin Area Rail Transit',
          description: 'Passenger rail serving Sonoma and Marin counties',
          website: 'https://www.sonomamarintrain.org',
          phone: '(707) 794-3330',
        },
        {
          name: 'SF Bay Ferry',
          fullName: 'San Francisco Bay Ferry',
          description: 'Ferry service connecting SF, Oakland, Alameda, and Vallejo',
          website: 'https://www.sanfranciscobayferry.com',
          phone: '(707) 643-3779',
        },
        {
          name: 'Golden Gate Ferry',
          fullName: 'Golden Gate Ferry',
          description: 'Ferry service between SF and Marin County (Sausalito, Larkspur)',
          website: 'https://www.goldengate.org/ferry/',
          phone: '(415) 455-2000',
        },
      ];

      container.innerHTML = '';

      agencies.forEach((agency) => {
        const card = document.createElement('div');
        card.className =
          'bg-white dark:bg-neutral-800 rounded-lg border border-neutral-200 dark:border-neutral-700 p-6 shadow-sm hover:shadow-md transition-shadow';

        const name = document.createElement('h3');
        name.className = 'text-xl font-bold text-neutral-900 dark:text-white mb-2';
        name.textContent = agency.name;

        const fullName = document.createElement('p');
        fullName.className = 'text-sm text-neutral-600 dark:text-neutral-400 mb-3';
        fullName.textContent = agency.fullName;

        const desc = document.createElement('p');
        desc.className = 'text-sm text-neutral-700 dark:text-neutral-300 mb-4';
        desc.textContent = agency.description;

        const links = document.createElement('div');
        links.className = 'flex gap-3 pt-4 border-t border-neutral-200 dark:border-neutral-700';

        const websiteLink = document.createElement('a');
        websiteLink.href = agency.website;
        websiteLink.target = '_blank';
        websiteLink.rel = 'noopener noreferrer';
        websiteLink.className = 'text-sm text-primary-600 dark:text-primary-400 hover:underline';
        websiteLink.textContent = 'Website';

        const phoneLink = document.createElement('a');
        phoneLink.href = `tel:${agency.phone.replace(/\D/g, '')}`;
        phoneLink.className = 'text-sm text-primary-600 dark:text-primary-400 hover:underline';
        phoneLink.textContent = agency.phone;

        links.appendChild(websiteLink);
        links.appendChild(phoneLink);

        card.appendChild(name);
        card.appendChild(fullName);
        card.appendChild(desc);
        card.appendChild(links);
        container.appendChild(card);
      });
    }

    // Populate bus tab panel
    function populateBusPanel() {
      const panel = document.getElementById('bus-panel');
      if (!panel) return;

      const container = panel.querySelector('.grid');
      if (!container) return;

      const agencies = [
        {
          name: 'Muni',
          fullName: 'SF Municipal Transportation Agency',
          description: 'San Francisco bus, light rail, and cable car service',
          website: 'https://www.sfmta.com',
          phone: '311',
        },
        {
          name: 'AC Transit',
          fullName: 'Alameda-Contra Costa Transit',
          description: 'East Bay bus service in Alameda and Contra Costa counties',
          website: 'https://www.actransit.org',
          phone: '(510) 891-4777',
        },
        {
          name: 'VTA',
          fullName: 'Santa Clara Valley Transportation Authority',
          description: 'South Bay bus and light rail service',
          website: 'https://www.vta.org',
          phone: '(408) 321-2300',
        },
        {
          name: 'SamTrans',
          fullName: 'San Mateo County Transit District',
          description: 'San Mateo County bus service',
          website: 'https://www.samtrans.com',
          phone: '1-800-660-4287',
        },
        {
          name: 'Golden Gate Transit',
          fullName: 'Golden Gate Transit',
          description: 'Marin and Sonoma county bus service to SF',
          website: 'https://www.goldengate.org/bus/',
          phone: '(415) 455-2000',
        },
        {
          name: 'County Connection',
          fullName: 'County Connection',
          description: 'Central Contra Costa County bus service',
          website: 'https://www.countyconnection.com',
          phone: '(925) 676-1976',
        },
        {
          name: 'Marin Transit',
          fullName: 'Marin Transit',
          description: 'Local and regional bus service in Marin County',
          website: 'https://marintransit.org',
          phone: '(415) 455-2000',
        },
        {
          name: 'SolTrans',
          fullName: 'SolTrans',
          description: 'Vallejo and Benicia bus service',
          website: 'https://www.soltransride.com',
          phone: '(707) 648-4666',
        },
        {
          name: 'WestCat',
          fullName: 'Western Contra Costa Transit Authority',
          description: 'West Contra Costa County bus service',
          website: 'https://www.westcat.org',
          phone: '(510) 724-7993',
        },
        {
          name: 'Fairfield Suisun Transit',
          fullName: 'Fairfield and Suisun Transit',
          description: 'Fairfield and Suisun City bus service',
          website: 'https://www.fairfield.ca.gov/gov/depts/pw/transit/default.asp',
          phone: '(707) 422-2877',
        },
        {
          name: 'Tri Delta Transit',
          fullName: 'Tri Delta Transit',
          description: 'East Contra Costa County bus service',
          website: 'https://www.trideltatransit.com',
          phone: '(925) 754-6622',
        },
        {
          name: 'Union City Transit',
          fullName: 'Union City Transit',
          description: 'Local bus service in Union City',
          website: 'https://www.unioncity.org/284/Transit',
          phone: '(510) 471-1411',
        },
        {
          name: 'Wheels',
          fullName: 'Livermore Amador Valley Transit Authority',
          description: 'Tri-Valley area bus service (Livermore, Pleasanton, Dublin)',
          website: 'https://www.wheelsbus.com',
          phone: '(925) 455-7500',
        },
        {
          name: 'Dumbarton Express',
          fullName: 'Dumbarton Express',
          description: 'Express bus across Dumbarton Bridge (Union City to Palo Alto)',
          website: 'https://www.dumbartonexpress.com',
          phone: '1-800-660-4287',
        },
        {
          name: 'Sonoma County Transit',
          fullName: 'Sonoma County Transit',
          description: 'County-wide bus service in Sonoma County',
          website: 'https://sctransit.com',
          phone: '(707) 576-7433',
        },
        {
          name: 'Santa Rosa CityBus',
          fullName: 'Santa Rosa CityBus',
          description: 'Local bus service in Santa Rosa',
          website: 'https://srcity.org/1036/CityBus',
          phone: '(707) 543-3333',
        },
        {
          name: 'Petaluma Transit',
          fullName: 'Petaluma Transit',
          description: 'Local bus service in Petaluma',
          website: 'https://cityofpetaluma.org/petaluma-transit/',
          phone: '(707) 778-4460',
        },
        {
          name: 'Vine',
          fullName: 'Napa Valley VINE',
          description: 'Napa County bus service',
          website: 'https://www.ridethevine.com',
          phone: '(707) 251-2800',
        },
        {
          name: 'Emery Go-Round',
          fullName: 'Emery Go-Round',
          description: 'Free shuttle service in Emeryville',
          website: 'https://www.emerygoround.com',
          phone: '(510) 451-1566',
        },
      ];

      container.innerHTML = '';

      agencies.forEach((agency) => {
        const card = document.createElement('div');
        card.className =
          'bg-white dark:bg-neutral-800 rounded-lg border border-neutral-200 dark:border-neutral-700 p-6 shadow-sm hover:shadow-md transition-shadow';

        const name = document.createElement('h3');
        name.className = 'text-xl font-bold text-neutral-900 dark:text-white mb-2';
        name.textContent = agency.name;

        const fullName = document.createElement('p');
        fullName.className = 'text-sm text-neutral-600 dark:text-neutral-400 mb-3';
        fullName.textContent = agency.fullName;

        const desc = document.createElement('p');
        desc.className = 'text-sm text-neutral-700 dark:text-neutral-300 mb-4';
        desc.textContent = agency.description;

        const links = document.createElement('div');
        links.className = 'flex gap-3 pt-4 border-t border-neutral-200 dark:border-neutral-700';

        const websiteLink = document.createElement('a');
        websiteLink.href = agency.website;
        websiteLink.target = '_blank';
        websiteLink.rel = 'noopener noreferrer';
        websiteLink.className = 'text-sm text-primary-600 dark:text-primary-400 hover:underline';
        websiteLink.textContent = 'Website';

        const phoneLink = document.createElement('a');
        phoneLink.href = `tel:${agency.phone.replace(/\D/g, '')}`;
        phoneLink.className = 'text-sm text-primary-600 dark:text-primary-400 hover:underline';
        phoneLink.textContent = agency.phone;

        links.appendChild(websiteLink);
        links.appendChild(phoneLink);

        card.appendChild(name);
        card.appendChild(fullName);
        card.appendChild(desc);
        card.appendChild(links);
        container.appendChild(card);
      });
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      initTabs();
      initJourneyPlanner();
      loadLiveStatus();
      populateAirportsPanel();
      populateRailPanel();
      populateBusPanel();

      // Refresh status every 60 seconds
      setInterval(loadLiveStatus, 60000);
    });

    // Re-initialize on Astro page transitions
    document.addEventListener('astro:page-load', () => {
      initMap();
      initTabs();
      initJourneyPlanner();
      loadLiveStatus();
      populateAirportsPanel();
      populateRailPanel();
      populateBusPanel();
    });
  </script>
</BaseLayout>
