---
import BaseLayout from '../layouts/BaseLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import AirportStatus from '../components/AirportStatus.astro';
import WifiQRCode from '../components/WifiQRCode.astro';
import fs from 'fs';
import path from 'path';
import yaml from 'js-yaml';

// Load airports from YAML
const airportsPath = path.join(process.cwd(), 'src/data/airports.yml');
let airports: any[] = [];
try {
  const yamlContent = fs.readFileSync(airportsPath, 'utf8');
  const data = yaml.load(yamlContent) as any;
  airports = data?.airports || [];
} catch (e) {
  console.error('Failed to load airports:', e);
}

const AIRPORT_RESOURCE_LINKS: Record<
  string,
  { flights: string; terminalMaps: string; groundTransport: string; parking: string }
> = {
  SFO: {
    flights: 'https://www.flysfo.com/passengers/flight-info',
    terminalMaps: 'https://www.flysfo.com/maps',
    groundTransport: 'https://www.flysfo.com/passengers/ground-transportation',
    parking: 'https://www.flysfo.com/passengers/parking',
  },
  OAK: {
    flights: 'https://www.oaklandairport.com/flights/',
    terminalMaps: 'https://www.oaklandairport.com/maps/',
    groundTransport: 'https://www.oaklandairport.com/ground-transportation/',
    parking: 'https://www.oaklandairport.com/parking/',
  },
  SJC: {
    flights: 'https://www.flysanjose.com/flights',
    terminalMaps: 'https://maps.flysanjose.com/',
    groundTransport: 'https://www.flysanjose.com/public-transit-bike-pedestrian-access',
    parking: 'https://www.flysanjose.com/parking',
  },
};

const previewAlertCode = Astro.url.searchParams.get('previewAlert')?.toUpperCase() || '';
---

<BaseLayout
  title="Bay Area Airports - BayNavigator"
  description="Real-time status, delays, and weather for San Francisco (SFO), Oakland (OAK), and San Jose (SJC) airports. Check current conditions before you travel."
>
  <main class="airports-page container mx-auto px-4 py-8 max-w-6xl" id="main-content">
    <Breadcrumb items={[{ label: 'Airports', href: '/airports' }]} />

    <!-- Hero Section -->
    <section class="airports-hero mb-8" aria-labelledby="airports-title">
      <div
        class="inline-flex items-center justify-center w-16 h-16 bg-primary-100 dark:bg-primary-900/30 rounded-full mb-4"
        aria-hidden="true"
      >
        <svg
          class="w-8 h-8 text-primary-700 dark:text-primary-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
        </svg>
      </div>
      <h1
        id="airports-title"
        class="text-3xl md:text-4xl font-bold text-neutral-900 dark:text-white mb-4"
      >
        Bay Area Airports
      </h1>
      <p class="text-lg text-neutral-700 dark:text-neutral-300 max-w-2xl mx-auto">
        Real-time status, delays, and weather for the {airports.length} major Bay Area airports. Check
        current conditions before you travel.
      </p>
      {
        previewAlertCode && (
          <p class="mt-3 text-sm text-amber-700 dark:text-amber-300">
            Preview mode: showing active delay alert for {previewAlertCode}
          </p>
        )
      }
    </section>

    <!-- Airport Cards -->
    <section aria-labelledby="airports-heading" class="airports-list mb-10">
      <h2 id="airports-heading" class="sr-only">Airport Status</h2>
      <div class="space-y-6">
        {
          airports.map((airport) => (
            <article
              class="airport-card overflow-hidden"
              aria-labelledby={`airport-${airport.code}-name`}
            >
              <div class="p-6 lg:p-7">
                <div class="flex flex-col lg:flex-row lg:items-start gap-5">
                  {/* Airport Info */}
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-3 mb-2">
                      <span class="airport-code-chip" aria-label={`Airport code: ${airport.code}`}>
                        {airport.code}
                      </span>
                      <h3
                        id={`airport-${airport.code}-name`}
                        class="text-xl font-semibold text-neutral-900 dark:text-white"
                      >
                        {airport.name}
                      </h3>
                    </div>
                    <p class="text-neutral-700 dark:text-neutral-300 mb-5">
                      {airport.city}, {airport.county} County
                    </p>

                    {/* Live Status */}
                    <div class="mb-5">
                      <AirportStatus
                        code={airport.code}
                        showWeather={true}
                        previewAlert={previewAlertCode === airport.code}
                      />
                    </div>

                    <div class="airport-detail-block">
                      <h4 class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">
                        Essential travel links
                      </h4>
                      <div class="airport-link-grid">
                        <a
                          href={AIRPORT_RESOURCE_LINKS[airport.code]?.flights || airport.website}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="airport-link-chip"
                        >
                          Flight status
                        </a>
                        <a
                          href={
                            AIRPORT_RESOURCE_LINKS[airport.code]?.terminalMaps || airport.website
                          }
                          target="_blank"
                          rel="noopener noreferrer"
                          class="airport-link-chip"
                        >
                          Terminal maps
                        </a>
                        <a
                          href={
                            AIRPORT_RESOURCE_LINKS[airport.code]?.groundTransport || airport.website
                          }
                          target="_blank"
                          rel="noopener noreferrer"
                          class="airport-link-chip"
                        >
                          Ground transportation
                        </a>
                        <a
                          href={AIRPORT_RESOURCE_LINKS[airport.code]?.parking || airport.website}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="airport-link-chip"
                        >
                          Parking info
                        </a>
                      </div>
                    </div>
                  </div>

                  {/* Quick Links */}
                  <div class="airport-actions">
                    <a
                      href={airport.website}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="flex items-center justify-center gap-2 px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        aria-hidden="true"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                        />
                      </svg>
                      <span>Official Site</span>
                      <span class="sr-only">(opens in new tab)</span>
                    </a>
                    <a
                      href={`tel:${airport.phone.replace(/[^0-9]/g, '')}`}
                      class="flex items-center justify-center gap-2 px-4 py-2 bg-neutral-100 dark:bg-neutral-700 hover:bg-neutral-200 dark:hover:bg-neutral-600 text-neutral-700 dark:text-neutral-300 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:ring-offset-2"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        aria-hidden="true"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                        />
                      </svg>
                      <span>{airport.phone}</span>
                    </a>
                    <a
                      href={`https://maps.apple.com/?ll=${airport.coordinates.lat},${airport.coordinates.lng}&q=${encodeURIComponent(airport.name)}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="flex items-center justify-center gap-2 px-4 py-2 bg-neutral-100 dark:bg-neutral-700 hover:bg-neutral-200 dark:hover:bg-neutral-600 text-neutral-700 dark:text-neutral-300 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:ring-offset-2"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        aria-hidden="true"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                        />
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                        />
                      </svg>
                      <span>Directions</span>
                      <span class="sr-only">(opens in new tab)</span>
                    </a>
                    {airport.wifi?.ssid && (
                      <button
                        type="button"
                        class="wifi-qr-btn flex items-center justify-center gap-2 px-4 py-2 bg-cyan-100 dark:bg-cyan-900/30 hover:bg-cyan-200 dark:hover:bg-cyan-800/50 text-cyan-800 dark:text-cyan-300 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2"
                        data-wifi-ssid={airport.wifi.ssid}
                        data-wifi-password={airport.wifi.password || ''}
                        title={`Show WiFi QR code for ${airport.wifi.ssid}`}
                      >
                        <svg
                          class="w-4 h-4"
                          fill="currentColor"
                          viewBox="0 0 24 24"
                          aria-hidden="true"
                        >
                          <path d="M12 18c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm-4.9-2.3c2.7-2.7 7.1-2.7 9.8 0l1.4-1.4c-3.5-3.5-9.1-3.5-12.6 0l1.4 1.4zm-2.8-2.8c4.3-4.3 11.2-4.3 15.4 0l1.4-1.4c-5-5-13.2-5-18.2 0l1.4 1.4zM1.5 10c5.8-5.8 15.2-5.8 21 0l1.4-1.4c-6.6-6.6-17.2-6.6-23.8 0L1.5 10z" />
                        </svg>
                        <span>Free WiFi</span>
                      </button>
                    )}
                  </div>
                </div>
              </div>
            </article>
          ))
        }
      </div>
    </section>

    <!-- Travel Resources Section -->
    <section aria-labelledby="resources-heading" class="travel-resources rounded-xl p-6 mb-8">
      <h2
        id="resources-heading"
        class="text-xl font-semibold text-neutral-900 dark:text-white mb-4"
      >
        Travel Resources
      </h2>
      <div class="grid md:grid-cols-2 gap-4">
        <a
          href="https://www.tsa.gov/travel"
          target="_blank"
          rel="noopener noreferrer"
          class="resource-link"
        >
          <div
            class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center flex-shrink-0"
          >
            <svg
              class="w-5 h-5 text-blue-600 dark:text-blue-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
              ></path>
            </svg>
          </div>
          <div>
            <span class="font-medium text-neutral-900 dark:text-white">TSA Travel Tips</span>
            <p class="text-sm text-neutral-700 dark:text-neutral-400">
              Security screening guidelines
            </p>
          </div>
          <span class="sr-only">(opens in new tab)</span>
        </a>

        <a
          href="https://www.tsa.gov/travel/security-screening/whatcanibring/all"
          target="_blank"
          rel="noopener noreferrer"
          class="resource-link"
        >
          <div
            class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center flex-shrink-0"
          >
            <svg
              class="w-5 h-5 text-green-600 dark:text-green-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
              ></path>
            </svg>
          </div>
          <div>
            <span class="font-medium text-neutral-900 dark:text-white">What Can I Bring?</span>
            <p class="text-sm text-neutral-700 dark:text-neutral-400">TSA prohibited items list</p>
          </div>
          <span class="sr-only">(opens in new tab)</span>
        </a>

        <a
          href="https://www.tsa.gov/precheck"
          target="_blank"
          rel="noopener noreferrer"
          class="resource-link"
        >
          <div
            class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center flex-shrink-0"
          >
            <svg
              class="w-5 h-5 text-purple-600 dark:text-purple-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
          </div>
          <div>
            <span class="font-medium text-neutral-900 dark:text-white">TSA PreCheck</span>
            <p class="text-sm text-neutral-700 dark:text-neutral-400">
              Expedited security screening
            </p>
          </div>
          <span class="sr-only">(opens in new tab)</span>
        </a>

        <a href="/transit" class="resource-link">
          <div
            class="w-10 h-10 bg-teal-100 dark:bg-teal-900/30 rounded-lg flex items-center justify-center flex-shrink-0"
          >
            <svg
              class="w-5 h-5 text-teal-600 dark:text-teal-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7h8m-8 4h8m-6 4h4M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"
              ></path>
            </svg>
          </div>
          <div>
            <span class="font-medium text-neutral-900 dark:text-white">Bay Area Transit</span>
            <p class="text-sm text-neutral-700 dark:text-neutral-400">
              BART, Caltrain & bus connections
            </p>
          </div>
        </a>
      </div>
    </section>

    <!-- Data Attribution -->
    <p class="airports-attribution text-xs text-neutral-500 dark:text-neutral-400 text-center">
      Airport status data provided by the{' '}
      <a
        href="https://www.faa.gov/"
        target="_blank"
        rel="noopener noreferrer"
        class="text-primary-700 dark:text-primary-400 hover:underline focus:outline-none focus:ring-2 focus:ring-primary-500"
      >
        Federal Aviation Administration (FAA)
      </a>. Weather data from{' '}
      <a
        href="https://weather.gov/"
        target="_blank"
        rel="noopener noreferrer"
        class="text-primary-700 dark:text-primary-400 hover:underline focus:outline-none focus:ring-2 focus:ring-primary-500"
      >
        NOAA's National Weather Service
      </a>. Status refreshes every 5 minutes.
    </p>
  </main>

  <style>
    .airports-page {
      --air-surface-light:
        radial-gradient(circle at 85% 12%, rgba(232, 169, 53, 0.14), transparent 42%),
        linear-gradient(150deg, #ffffff 0%, #f7fafc 58%, #f3f7fb 100%);
      --air-surface-dark:
        radial-gradient(circle at 85% 12%, rgba(212, 143, 24, 0.2), transparent 42%),
        linear-gradient(150deg, #1a2433 0%, #172130 58%, #131d2a 100%);
      --air-border-light: rgba(172, 200, 216, 0.56);
      --air-border-dark: rgba(82, 102, 121, 0.7);
      --air-shadow: 0 10px 26px rgba(15, 23, 32, 0.08);
    }

    .airports-hero {
      padding: 2rem 1.25rem;
      border: 1px solid var(--air-border-light);
      border-radius: 1rem;
      background: var(--air-surface-light);
      box-shadow: var(--air-shadow);
      text-align: center;
    }

    :global(.dark) .airports-hero {
      border-color: var(--air-border-dark);
      background: var(--air-surface-dark);
      box-shadow: none;
    }

    .airport-card {
      border-radius: 1rem;
      border: 1px solid var(--air-border-light);
      background: var(--air-surface-light);
      box-shadow: var(--air-shadow);
    }

    :global(.dark) .airport-card {
      border-color: var(--air-border-dark);
      background: var(--air-surface-dark);
      box-shadow: none;
    }

    .airport-code-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 3.25rem;
      padding: 0.35rem 0.55rem;
      border-radius: 0.6rem;
      border: 1px solid var(--air-border-light);
      background: rgba(255, 255, 255, 0.88);
      color: var(--color-primary-700, #1a4f6e);
      font-weight: 700;
      font-size: 1.125rem;
      line-height: 1;
    }

    :global(.dark) .airport-code-chip {
      border-color: var(--air-border-dark);
      background: rgba(17, 27, 38, 0.82);
      color: var(--color-primary-300, #5ba3c9);
    }

    .airport-detail-block {
      border: 1px solid var(--air-border-light);
      border-radius: 0.75rem;
      background: rgba(255, 255, 255, 0.82);
      padding: 0.85rem;
    }

    :global(.dark) .airport-detail-block {
      border-color: var(--air-border-dark);
      background: rgba(17, 27, 38, 0.84);
    }

    .airport-link-grid {
      display: grid;
      gap: 0.55rem;
    }

    @media (min-width: 640px) {
      .airport-link-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .airport-link-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 42px;
      border-radius: 0.625rem;
      border: 1px solid var(--air-border-light);
      background: rgba(255, 255, 255, 0.92);
      color: var(--color-primary-700, #1a4f6e);
      font-size: 0.8125rem;
      font-weight: 600;
      text-decoration: none;
      text-align: center;
      padding: 0.45rem 0.65rem;
      transition:
        transform 0.2s ease,
        border-color 0.2s ease,
        box-shadow 0.2s ease;
    }

    .airport-link-chip:hover {
      transform: translateY(-1px);
      border-color: rgba(120, 159, 184, 0.86);
      box-shadow: 0 6px 12px rgba(15, 23, 32, 0.08);
    }

    :global(.dark) .airport-link-chip {
      border-color: var(--air-border-dark);
      background: rgba(17, 27, 38, 0.92);
      color: var(--color-primary-300, #5ba3c9);
    }

    :global(.dark) .airport-link-chip:hover {
      border-color: rgba(112, 145, 168, 0.95);
      box-shadow: none;
    }

    .airport-actions {
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      width: 100%;
    }

    @media (min-width: 1024px) {
      .airport-actions {
        width: 12.5rem;
      }
    }

    .travel-resources {
      border: 1px solid var(--air-border-light);
      background: var(--air-surface-light);
      box-shadow: var(--air-shadow);
    }

    :global(.dark) .travel-resources {
      border-color: var(--air-border-dark);
      background: var(--air-surface-dark);
      box-shadow: none;
    }

    .resource-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--air-border-light);
      background: rgba(255, 255, 255, 0.88);
      transition:
        transform 0.2s ease,
        box-shadow 0.2s ease,
        border-color 0.2s ease;
    }

    .resource-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(15, 23, 32, 0.08);
      border-color: rgba(142, 175, 196, 0.7);
    }

    :global(.dark) .resource-link {
      border-color: var(--air-border-dark);
      background: rgba(17, 27, 38, 0.84);
    }

    :global(.dark) .resource-link:hover {
      border-color: rgba(108, 139, 161, 0.9);
      box-shadow: none;
    }

    .airports-attribution {
      max-width: 66ch;
      margin: 0 auto;
      line-height: 1.45;
    }

    @media (prefers-reduced-motion: reduce) {
      .resource-link,
      .resource-link:hover {
        transform: none;
        transition: none;
        box-shadow: none;
      }

      .airport-link-chip,
      .airport-link-chip:hover {
        transform: none;
        transition: none;
        box-shadow: none;
      }
    }
  </style>

  <!-- WiFi QR Code Modal -->
  <WifiQRCode />

  <script>
    function initWifiQRButtons(): void {
      document.querySelectorAll('.wifi-qr-btn').forEach((btn) => {
        // Skip if already initialized
        if (btn.hasAttribute('data-wifi-initialized')) return;
        btn.setAttribute('data-wifi-initialized', 'true');

        btn.addEventListener('click', (e) => {
          const button = e.currentTarget as HTMLElement;
          const ssid = button.getAttribute('data-wifi-ssid');
          const password = button.getAttribute('data-wifi-password');

          if (ssid) {
            const openWifiModal = (window as any).openWifiQRModal;
            if (openWifiModal) {
              openWifiModal(ssid, password || undefined);
            }
          }
        });
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initWifiQRButtons);
    document.addEventListener('astro:page-load', initWifiQRButtons);
  </script>
</BaseLayout>
