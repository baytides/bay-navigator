---
import BaseLayout from '../layouts/BaseLayout.astro';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Load custom theme configuration (sports teams, patriotic, special events)
const customThemeFile = path.join(process.cwd(), 'src/data/custom-themes.yml');
let activeTeamTheme: any = null;

if (fs.existsSync(customThemeFile)) {
  const themeData = yaml.load(fs.readFileSync(customThemeFile, 'utf8')) as any;

  const today = new Date().toISOString().split('T')[0];
  let activeThemeId = themeData.activeTheme;

  if (themeData.schedule && Array.isArray(themeData.schedule)) {
    for (const scheduled of themeData.schedule) {
      if (scheduled.start <= today && today <= scheduled.end) {
        activeThemeId = scheduled.team;
        break;
      }
    }
  }

  if (!activeThemeId || activeThemeId === 'default') {
    const sportsDataPath = path.join(process.cwd(), 'public', 'data', 'sports-data.json');
    if (fs.existsSync(sportsDataPath)) {
      try {
        const sportsData = JSON.parse(fs.readFileSync(sportsDataPath, 'utf8'));
        const priorityOrder = ['championship', 'playoffs', 'streak', 'hot'];

        let bestTeam: string | null = null;
        let bestPriority = priorityOrder.length;

        for (const [, team] of Object.entries(sportsData.teams || {}) as [string, any][]) {
          if (team.excitement) {
            const priority = priorityOrder.indexOf(team.excitement);
            if (priority !== -1 && priority < bestPriority) {
              bestPriority = priority;
              bestTeam = team.themeId;
            }
          }
        }

        if (bestTeam) {
          activeThemeId = bestTeam === 'champions' ? 'champions' : bestTeam;
        }
      } catch {
        // Sports data unavailable — skip
      }
    }
  }

  if (activeThemeId && activeThemeId !== 'default') {
    const themeSource = themeData.teams?.[activeThemeId] || themeData.special?.[activeThemeId];
    if (themeSource) {
      activeTeamTheme = { id: activeThemeId, ...themeSource };
    }
  }
}

// Load all programs
const dataDir = path.join(process.cwd(), 'src/data');
const NON_PROGRAM_FILES = [
  'cities.yml',
  'groups.yml',
  'zipcodes.yml',
  'suppressed.yml',
  'search-config.yml',
  'transit-agencies.yml',
  'county-supervisors.yml',
  'site-config.yml',
  'bay-area-jurisdictions.yml',
  'city-profiles.yml',
  'helplines.yml',
  'custom-themes.yml',
  'chat-messages.yml',
];

const suppressedFile = path.join(dataDir, 'suppressed.yml');
let suppressedIds = new Set<string>();
if (fs.existsSync(suppressedFile)) {
  const suppressedData = yaml.load(fs.readFileSync(suppressedFile, 'utf8')) as any[];
  if (Array.isArray(suppressedData)) {
    suppressedIds = new Set(suppressedData.map((s) => s.id));
  }
}

const allPrograms: any[] = [];
const categoryCounts: Record<string, number> = {};
const files = fs
  .readdirSync(dataDir)
  .filter((f) => f.endsWith('.yml') && !NON_PROGRAM_FILES.includes(f));

for (const file of files) {
  const content = fs.readFileSync(path.join(dataDir, file), 'utf8');
  const data = yaml.load(content) as any;
  if (!data) continue;
  const programs = Array.isArray(data) ? data : data.programs || [];

  for (const program of programs) {
    const category =
      program.category ||
      file
        .replace('.yml', '')
        .replace(/-/g, ' ')
        .replace(/\b\w/g, (c: string) => c.toUpperCase());
    const id =
      program.id ||
      `${category.toLowerCase().replace(/\s+/g, '-')}-${(program.name || '').toLowerCase().replace(/[^a-z0-9]+/g, '-')}`;

    if (!suppressedIds.has(id)) {
      allPrograms.push({ ...program, id, category, groups: program.groups || [] });
      categoryCounts[category] = (categoryCounts[category] || 0) + 1;
    }
  }
}

// Load helplines
const helplinesFile = path.join(dataDir, 'helplines.yml');
let helplines: any[] = [];
try {
  const helplinesData = yaml.load(fs.readFileSync(helplinesFile, 'utf8')) as any;
  helplines = helplinesData?.helplines || [];
} catch {
  // Helplines unavailable
}

// Load groups
const groupsFile = path.join(dataDir, 'groups.yml');
let groups: any[] = [];
try {
  const groupsData = yaml.load(fs.readFileSync(groupsFile, 'utf8')) as any;
  groups = groupsData?.groups || [];
} catch {
  // Groups unavailable
}

// Missing persons data is now loaded at runtime from Azure Blob Storage

// Build situation data — top programs per category for expand panels
function getTopPrograms(category: string, limit = 4) {
  return allPrograms.filter((p) => p.category === category).slice(0, limit);
}

// Get unique groups that appear in a given category
function getCategoryGroups(category: string) {
  const groupIds = new Set<string>();
  allPrograms
    .filter((p) => p.category === category)
    .forEach((p) => (p.groups || []).forEach((g: string) => groupIds.add(g)));
  return groups.filter((g) => groupIds.has(g.id)).slice(0, 6);
}

const foodPrograms = getTopPrograms('Food');
const foodGroups = getCategoryGroups('Food');
const utilityPrograms = getTopPrograms('Utilities');
const housingPrograms = getTopPrograms('Housing');
const healthPrograms = getTopPrograms('Health');
const jobsPrograms = getTopPrograms('Employment');
const jobsGroups = getCategoryGroups('Employment');
const legalPrograms = getTopPrograms('Legal Services');
const legalGroups = getCategoryGroups('Legal Services');
const transitPrograms = getTopPrograms('Transportation');
const transitGroups = getCategoryGroups('Transportation');
const educationPrograms = getTopPrograms('Education');
const educationGroups = getCategoryGroups('Education');

// Count programs per situation
const foodCount = categoryCounts['Food'] || 0;
const utilityCount = categoryCounts['Utilities'] || 0;
const housingCount = categoryCounts['Housing'] || 0;
const healthCount = categoryCounts['Health'] || 0;
const jobsCount = categoryCounts['Employment'] || 0;
const legalCount = categoryCounts['Legal Services'] || 0;
const transitCount = categoryCounts['Transportation'] || 0;
const educationCount = categoryCounts['Education'] || 0;

const totalPrograms = allPrograms.length;

// Extract key crisis helplines for the crisis strip
const crisisHelplines = [
  helplines.find((h) => h.phone === '988'),
  helplines.find(
    (h) => h.phone === '211' || h.name?.toLowerCase().includes('2-1-1') || h.id?.includes('211')
  ),
  helplines.find(
    (h) =>
      h.phone === '18007997233' ||
      h.name?.toLowerCase().includes('domestic violence') ||
      h.name?.toLowerCase().includes('hotline')
  ),
].filter(Boolean);

// Typesense config — evaluated in frontmatter so we can pass via define:vars
const typesenseBaseUrl = 'https://search.baytides.org';
const typesenseSearchKey = 'fOjrMAfZl4tb9Dux7ZZEdSOGXWjFzu5N';
---

<BaseLayout
  title="Home"
  description="Find free and low-cost programs for food, housing, healthcare, utilities, and more across the San Francisco Bay Area."
>
  <main id="main-content" class="home-page max-w-5xl mx-auto px-4">
    <!-- ========================================== -->
    <!-- SEARCH: Dual-path — Browse or Ask Carl -->
    <!-- ========================================== -->
    <section
      id="hero-section"
      class="home-hero relative pt-14 pb-6 overflow-hidden"
      aria-labelledby="search-heading"
    >
      <div class="relative z-10">
        <h1
          id="search-heading"
          class="animate-reveal font-display text-4xl sm:text-5xl font-semibold text-primary-900 dark:text-white mb-3 tracking-tight text-center leading-tight"
          style="--delay: 0ms"
          data-i18n="home.heroTitle"
        >
          Find programs, services, and resources in the San Francisco Bay Area
        </h1>
        <p
          class="animate-reveal text-neutral-600 dark:text-neutral-300 text-base sm:text-lg mb-8 text-center max-w-2xl mx-auto"
          style="--delay: 80ms"
          data-i18n="home.heroSubtitle"
        >
          Discover free and low-cost resources for food, housing, healthcare, utilities, and more.
        </p>

        <!-- Unified search bar — auto-detects conversational queries for Carl -->
        <div
          class="animate-reveal search-glow home-search-shell max-w-2xl mx-auto rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 shadow-md hover:shadow-lg transition-shadow"
          style="--delay: 160ms"
        >
          <div class="flex items-center gap-3 px-4 py-3.5">
            <svg
              class="w-4 h-4 text-neutral-500 dark:text-neutral-400 flex-shrink-0"
              fill="none"
              viewBox="0 0 20 20"
              stroke="currentColor"
              stroke-width="1.7"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 3.5a5.5 5.5 0 1 1 0 11a5.5 5.5 0 0 1 0-11Zm4.2 9.7l3.3 3.3"></path>
            </svg>
            <input
              id="search-input"
              type="search"
              class="search-input flex-1 text-base outline-none bg-transparent placeholder:text-neutral-400 dark:placeholder:text-neutral-500 text-neutral-900 dark:text-white"
              placeholder='Try: "food banks near me" or "help paying my electric bill"'
              autocomplete="off"
              aria-label="Search programs and services"
            />
            <!-- Carl badge — appears when conversational query is detected -->
            <span
              id="carl-badge"
              class="hidden items-center gap-1.5 text-xs text-accent-800 dark:text-accent-300 bg-accent-50 dark:bg-accent-900/40 px-2.5 py-1 rounded-lg font-medium"
              aria-hidden="true"
            >
              <svg
                class="w-3.5 h-3.5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"
                ></path>
              </svg>
              Carl
            </span>
            <!-- Hidden mode state for JS compatibility -->
            <div class="mode-toggle sr-only" role="group" aria-label="Search mode">
              <button id="mode-browse" class="mode-toggle-btn" aria-pressed="true">Browse</button>
              <button id="mode-carl" class="mode-toggle-btn" aria-pressed="false">Ask Carl</button>
            </div>
            <button
              id="search-submit-btn"
              class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-xl bg-primary-700 text-white hover:bg-primary-800 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-900"
              aria-label="Search"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                viewBox="0 0 20 20"
                stroke="currentColor"
                stroke-width="1.9"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9 3.5a5.5 5.5 0 1 1 0 11a5.5 5.5 0 0 1 0-11Zm4.2 9.7l3.3 3.3"></path>
              </svg>
            </button>
          </div>

          <!-- Location row (city / zip) -->
          <div
            class="border-t border-neutral-100 dark:border-neutral-700/50 px-4 py-2 flex items-center gap-3"
          >
            <svg
              class="w-4 h-4 text-neutral-400 dark:text-neutral-500 flex-shrink-0"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 0115 0z"
              ></path>
            </svg>
            <div class="relative flex-1">
              <input
                id="location-input"
                type="text"
                class="w-full text-sm outline-none bg-transparent placeholder:text-neutral-400 dark:placeholder:text-neutral-500 text-neutral-900 dark:text-neutral-200"
                placeholder="City or ZIP code"
                autocomplete="off"
                aria-label="Filter by city or ZIP code"
                aria-expanded="false"
                aria-controls="location-dropdown"
                role="combobox"
                aria-autocomplete="list"
              />
              <div
                id="location-dropdown"
                class="location-dropdown"
                role="listbox"
                aria-label="City suggestions"
              >
                <!-- Populated by JS -->
              </div>
            </div>
            <button
              id="detect-location-btn"
              class="text-xs text-primary-700 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 font-medium whitespace-nowrap px-2 py-1 rounded-lg hover:bg-primary-50 dark:hover:bg-primary-900/30 transition-colors"
              aria-label="Near me — use my current location"
            >
              <span class="flex items-center gap-1">
                <svg
                  class="w-3.5 h-3.5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 12m-2 0a2 2 0 104 0 2 2 0 10-4 0m0-7v2m0 10v2m7-7h-2M5 12H3"></path>
                </svg>
                Near me
              </span>
            </button>
          </div>
        </div>

        <!-- Program count -->
        <p
          class="animate-reveal text-center text-sm text-neutral-500 dark:text-neutral-400 mt-3"
          style="--delay: 240ms"
        >
          <span class="font-semibold text-primary-700 dark:text-primary-400">{totalPrograms}+</span>
          <span data-i18n="home.programsFound">programs found</span>
        </p>
        <span id="mode-hint" class="sr-only" aria-live="polite">Search by category or keyword</span>
      </div>
    </section>

    <!-- ========================================== -->
    <!-- CONTEXTUAL PILLS — live, timely info -->
    <!-- ========================================== -->
    <div class="pill-scroll-container py-3" role="region" aria-label="Current alerts and events">
      <div class="flex gap-2.5 overflow-x-auto scrollbar-hide pb-1">
        <a
          href="/directory?category=Tax%20Preparation"
          class="flex-shrink-0 flex items-center gap-2 px-4 py-2.5 rounded-full bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 text-neutral-800 dark:text-neutral-200 text-sm hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors no-underline"
        >
          <span class="w-2 h-2 rounded-full bg-amber-500 flex-shrink-0" aria-hidden="true"></span>
          <span class="font-medium">Tax filing help</span>
          <span class="text-neutral-600 dark:text-neutral-400">through Apr 15</span>
        </a>
        <a
          href="/transit"
          class="flex-shrink-0 flex items-center gap-2 px-4 py-2.5 rounded-full bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 text-neutral-800 dark:text-neutral-200 text-sm hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors no-underline"
        >
          <span class="w-2 h-2 rounded-full bg-blue-500 flex-shrink-0" aria-hidden="true"></span>
          <span class="font-medium">Transit status</span>
          <span class="text-neutral-600 dark:text-neutral-400">Live updates</span>
        </a>
        <a
          href="/eligibility"
          class="flex-shrink-0 flex items-center gap-2 px-4 py-2.5 rounded-full bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 text-neutral-800 dark:text-neutral-200 text-sm hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors no-underline"
        >
          <span class="w-2 h-2 rounded-full bg-emerald-500 flex-shrink-0" aria-hidden="true"></span>
          <span class="font-medium">Eligibility guide</span>
          <span class="text-neutral-600 dark:text-neutral-400">2-min quiz</span>
        </a>
        <a
          href="/directory?category=Education"
          class="flex-shrink-0 flex items-center gap-2 px-4 py-2.5 rounded-full bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 text-neutral-800 dark:text-neutral-200 text-sm hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors no-underline"
        >
          <span class="w-2 h-2 rounded-full bg-purple-500 flex-shrink-0" aria-hidden="true"></span>
          <span class="font-medium">FAFSA deadline</span>
          <span class="text-neutral-600 dark:text-neutral-400">Mar 2</span>
        </a>
      </div>
    </div>

    <!-- ========================================== -->
    <!-- CRISIS STRIP — immediate help resources  -->
    <!-- ========================================== -->
    <section
      class="my-4 rounded-xl bg-accent-50 dark:bg-accent-900/20 border border-accent-200 dark:border-accent-800/50 px-4 py-3"
      aria-label="Crisis resources"
    >
      <div class="flex flex-wrap items-center justify-center gap-x-6 gap-y-2">
        <span
          class="text-xs font-semibold uppercase tracking-wide text-accent-800 dark:text-accent-300"
          data-i18n="safety.needHelp">Need immediate help?</span
        >
        <div class="flex flex-wrap items-center gap-x-5 gap-y-2">
          <a
            href="tel:988"
            class="group flex items-center gap-2 text-sm font-medium text-accent-900 dark:text-accent-200 hover:text-accent-700 dark:hover:text-accent-100 no-underline transition-colors"
          >
            <svg
              class="w-4 h-4 text-accent-600 dark:text-accent-400 group-hover:scale-110 transition-transform"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"
              ></path>
            </svg>
            <span data-i18n="safety.call988">Call/Text 988</span>
          </a>
          <span class="text-accent-300 dark:text-accent-700" aria-hidden="true">|</span>
          <a
            href="tel:211"
            class="group flex items-center gap-2 text-sm font-medium text-accent-900 dark:text-accent-200 hover:text-accent-700 dark:hover:text-accent-100 no-underline transition-colors"
          >
            <svg
              class="w-4 h-4 text-accent-600 dark:text-accent-400 group-hover:scale-110 transition-transform"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"
              ></path>
            </svg>
            <span>2-1-1</span>
          </a>
          <span class="text-accent-300 dark:text-accent-700" aria-hidden="true">|</span>
          <a
            href="tel:18007997233"
            class="group flex items-center gap-2 text-sm font-medium text-accent-900 dark:text-accent-200 hover:text-accent-700 dark:hover:text-accent-100 no-underline transition-colors"
          >
            <svg
              class="w-4 h-4 text-accent-600 dark:text-accent-400 group-hover:scale-110 transition-transform"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z"
              ></path>
            </svg>
            <span>DV Hotline</span>
          </a>
        </div>
      </div>
    </section>

    <!-- ========================================== -->
    <!-- SITUATION CARDS — progressive disclosure -->
    <!-- ========================================== -->
    <section class="py-6" aria-labelledby="situations-heading">
      <h2
        id="situations-heading"
        class="font-display text-xl font-semibold text-neutral-800 dark:text-neutral-200 mb-4"
        data-i18n="home.browseByCategory"
      >
        I need help with&hellip;
      </h2>

      <!-- Asymmetric grid: top 2 span wide, bottom 3 are equal -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
        <!-- Food — large card spanning 2 cols on lg -->
        <button
          class="situation-card text-left rounded-xl border-l-4 border-l-red-500 border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4 hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-md cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-neutral-900 lg:col-span-2"
          data-expand="food"
          aria-expanded="false"
          aria-controls="expand-food"
        >
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 mt-0.5" aria-hidden="true">
              <svg
                class="w-7 h-7 text-red-500"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007ZM8.625 10.5a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm7.5 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"
                ></path></svg
              >
            </div>
            <div>
              <div
                class="font-semibold text-neutral-900 dark:text-white text-sm"
                data-i18n="categories.food"
              >
                Food & Groceries
              </div>
              <div class="text-xs text-neutral-600 dark:text-neutral-400 mt-0.5">
                Food banks, CalFresh, meals &middot; {foodCount} programs
              </div>
            </div>
          </div>
        </button>

        <!-- Housing — large card spanning 2 cols on lg -->
        <button
          class="situation-card text-left rounded-xl border-l-4 border-l-primary-600 border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4 hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-md cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-neutral-900 lg:col-span-2"
          data-expand="housing"
          aria-expanded="false"
          aria-controls="expand-housing"
        >
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 mt-0.5" aria-hidden="true">
              <svg
                class="w-7 h-7 text-primary-700 dark:text-primary-400"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"
                ></path></svg
              >
            </div>
            <div>
              <div
                class="font-semibold text-neutral-900 dark:text-white text-sm"
                data-i18n="categories.housing"
              >
                Housing & Shelter
              </div>
              <div class="text-xs text-neutral-600 dark:text-neutral-400 mt-0.5">
                Shelters, rent help, housing &middot; {housingCount} programs
              </div>
            </div>
          </div>
        </button>

        <!-- Health -->
        <button
          class="situation-card text-left rounded-xl border-l-4 border-l-rose-500 border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4 hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-md cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-neutral-900"
          data-expand="health"
          aria-expanded="false"
          aria-controls="expand-health"
        >
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 mt-0.5" aria-hidden="true">
              <svg
                class="w-6 h-6 text-rose-500"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z"
                ></path></svg
              >
            </div>
            <div>
              <div
                class="font-semibold text-neutral-900 dark:text-white text-sm"
                data-i18n="categories.health"
              >
                Health & Medical
              </div>
              <div class="text-xs text-neutral-600 dark:text-neutral-400 mt-0.5">
                Medi-Cal, clinics, mental health
              </div>
            </div>
          </div>
        </button>

        <!-- Bills & Utilities -->
        <button
          class="situation-card text-left rounded-xl border-l-4 border-l-amber-500 border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4 hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-md cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-neutral-900"
          data-expand="bills"
          aria-expanded="false"
          aria-controls="expand-bills"
        >
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 mt-0.5" aria-hidden="true">
              <svg
                class="w-6 h-6 text-amber-500"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"
                ></path></svg
              >
            </div>
            <div>
              <div
                class="font-semibold text-neutral-900 dark:text-white text-sm"
                data-i18n="categories.utilities"
              >
                Bills & Utilities
              </div>
              <div class="text-xs text-neutral-600 dark:text-neutral-400 mt-0.5">
                CARE, FERA, bill assistance
              </div>
            </div>
          </div>
        </button>

        <!-- Jobs & Legal — combined -->
        <button
          class="situation-card text-left rounded-xl border-l-4 border-l-indigo-500 border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4 hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-md cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-neutral-900 col-span-2 lg:col-span-2"
          data-expand="jobs"
          aria-expanded="false"
          aria-controls="expand-jobs"
        >
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 mt-0.5" aria-hidden="true">
              <svg
                class="w-6 h-6 text-indigo-600 dark:text-indigo-400"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 0 0 .75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 0 0-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0 1 12 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 0 1-.673-.38m0 0A2.18 2.18 0 0 1 3 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 0 1 3.413-.387m7.5 0V5.25A2.25 2.25 0 0 0 13.5 3h-3a2.25 2.25 0 0 0-2.25 2.25v.894m7.5 0a48.667 48.667 0 0 0-7.5 0M12 12.75h.008v.008H12v-.008Z"
                ></path></svg
              >
            </div>
            <div>
              <div class="font-semibold text-neutral-900 dark:text-white text-sm">
                Jobs, Legal & More
              </div>
              <div class="text-xs text-neutral-600 dark:text-neutral-400 mt-0.5">
                Job search, legal aid, immigration, education, transit
              </div>
            </div>
          </div>
        </button>
      </div>

      <!-- Secondary quick links for categories folded into Jobs & Legal -->
      <div class="flex flex-wrap gap-2 mt-3">
        <a
          href="/directory?category=Legal%20Services"
          class="text-xs text-primary-700 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 bg-primary-50 dark:bg-primary-900/30 px-3 py-1.5 rounded-full no-underline transition-colors"
          data-i18n="categories.legal">Legal</a
        >
        <a
          href="/transit"
          class="text-xs text-primary-700 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 bg-primary-50 dark:bg-primary-900/30 px-3 py-1.5 rounded-full no-underline transition-colors"
          data-i18n="categories.transportation">Transportation</a
        >
        <a
          href="/directory?category=Education"
          class="text-xs text-primary-700 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 bg-primary-50 dark:bg-primary-900/30 px-3 py-1.5 rounded-full no-underline transition-colors"
          data-i18n="categories.education">Education</a
        >
        <a
          href="/directory"
          class="text-xs text-neutral-600 dark:text-neutral-400 hover:text-primary-700 dark:hover:text-primary-300 px-3 py-1.5 rounded-full no-underline transition-colors"
          data-i18n="home.viewAllDirectory">View all programs in directory &rarr;</a
        >
      </div>

      <!-- ======================================== -->
      <!-- EXPAND PANELS — CSS grid animation -->
      <!-- ======================================== -->

      <!-- FOOD expand -->
      <div
        id="expand-food"
        class="expand-grid rounded-xl bg-primary-50/50 dark:bg-primary-900/20"
        data-open="false"
        role="region"
        aria-label="Food & Groceries details"
      >
        <div class="expand-inner">
          <div class="p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-primary-900 dark:text-primary-200">Food & Groceries</h3>
              <button
                class="expand-close text-sm font-medium text-primary-900 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 px-2 py-1 rounded-lg hover:bg-primary-100 dark:hover:bg-primary-900/30 transition-colors"
                data-expand="food"
                aria-label="Close food section">Close</button
              >
            </div>
            <div class="grid gap-3 sm:grid-cols-2 mb-4">
              {
                foodPrograms.map((p) => (
                  <a
                    href={`/directory?program=${p.id}`}
                    class="block rounded-lg bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 p-3 hover:shadow-sm transition-shadow no-underline"
                  >
                    <div class="font-medium text-sm text-neutral-900 dark:text-white">{p.name}</div>
                    <div class="text-xs text-neutral-700 dark:text-neutral-400 mt-0.5 line-clamp-1">
                      {p.description?.slice(0, 60)}...
                    </div>
                    <div class="text-xs text-primary-700 dark:text-primary-400 mt-1">{p.area}</div>
                  </a>
                ))
              }
            </div>
            {
              foodGroups.length > 0 && (
                <div class="flex flex-wrap gap-1.5 mb-3">
                  <span class="text-xs text-neutral-700 dark:text-neutral-400 py-0.5">
                    Eligible if you're:
                  </span>
                  {foodGroups.map((g) => (
                    <a
                      href={`/directory?category=Food&group=${g.id}`}
                      class="text-xs bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 text-neutral-700 dark:text-neutral-300 px-2 py-0.5 rounded-full hover:border-primary-300 dark:hover:border-primary-600 hover:text-primary-700 dark:hover:text-primary-300 transition-colors no-underline"
                    >
                      {g.name}
                    </a>
                  ))}
                </div>
              )
            }
            <div
              class="rounded-lg bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 p-3 mb-3"
            >
              <div class="flex items-center gap-2 text-sm">
                <svg
                  class="w-4 h-4 text-amber-600 dark:text-amber-400 flex-shrink-0"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                  aria-hidden="true"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z"
                  ></path></svg
                >
                <span class="text-amber-900 dark:text-amber-200"
                  >Apply for CalFresh at <a
                    href="https://www.getcalfresh.org"
                    target="_blank"
                    rel="noopener"
                    class="font-bold underline">getcalfresh.org</a
                  > &mdash; most people are approved in 3 days</span
                >
              </div>
            </div>
            <a
              href="/directory?category=Food"
              class="text-sm font-medium text-primary-700 dark:text-primary-300 hover:text-primary-900 dark:hover:text-primary-100"
              >View all {foodCount} food programs &rarr;</a
            >
          </div>
        </div>
      </div>

      <!-- BILLS expand -->
      <div
        id="expand-bills"
        class="expand-grid rounded-xl bg-primary-50/50 dark:bg-primary-900/20"
        data-open="false"
        role="region"
        aria-label="Bills & Utilities details"
      >
        <div class="expand-inner">
          <div class="p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-primary-900 dark:text-primary-200">
                Bills & Utilities
              </h3>
              <button
                class="expand-close text-sm font-medium text-primary-900 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 px-2 py-1 rounded-lg hover:bg-primary-100 dark:hover:bg-primary-900/30 transition-colors"
                data-expand="bills"
                aria-label="Close bills section">Close</button
              >
            </div>
            <div class="grid gap-3 sm:grid-cols-2 mb-4">
              {
                utilityPrograms.map((p) => (
                  <a
                    href={`/directory?program=${p.id}`}
                    class="block rounded-lg bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 p-3 hover:shadow-sm transition-shadow no-underline"
                  >
                    <div class="font-medium text-sm text-neutral-900 dark:text-white">{p.name}</div>
                    <div class="text-xs text-neutral-700 dark:text-neutral-400 mt-0.5 line-clamp-1">
                      {p.description?.slice(0, 60)}...
                    </div>
                    <div class="text-xs text-primary-700 dark:text-primary-400 mt-1">{p.area}</div>
                  </a>
                ))
              }
            </div>
            <div
              class="rounded-lg bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 p-3 mb-3"
            >
              <div class="flex items-center gap-2 text-sm">
                <svg
                  class="w-4 h-4 text-red-600 dark:text-red-400 flex-shrink-0"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                  aria-hidden="true"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
                  ></path></svg
                >
                <span class="text-red-900 dark:text-red-200"
                  >Behind on PG&amp;E? Apply for CARE/FERA at <a
                    href="https://www.pge.com/care"
                    target="_blank"
                    rel="noopener"
                    class="font-bold underline">pge.com/care</a
                  > or call <a href="tel:18667432273" class="font-bold underline">1-866-743-2273</a
                  ></span
                >
              </div>
            </div>
            <a
              href="/directory?category=Utilities"
              class="text-sm font-medium text-primary-700 dark:text-primary-300 hover:text-primary-900 dark:hover:text-primary-100"
              >View all {utilityCount} utility programs &rarr;</a
            >
          </div>
        </div>
      </div>

      <!-- HOUSING expand -->
      <div
        id="expand-housing"
        class="expand-grid rounded-xl bg-primary-50/50 dark:bg-primary-900/20"
        data-open="false"
        role="region"
        aria-label="Housing & Shelter details"
      >
        <div class="expand-inner">
          <div class="p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-primary-900 dark:text-primary-200">
                Housing & Shelter
              </h3>
              <button
                class="expand-close text-sm font-medium text-primary-900 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 px-2 py-1 rounded-lg hover:bg-primary-100 dark:hover:bg-primary-900/30 transition-colors"
                data-expand="housing"
                aria-label="Close housing section">Close</button
              >
            </div>
            <div class="grid gap-3 sm:grid-cols-2 mb-4">
              {
                housingPrograms.map((p) => (
                  <a
                    href={`/directory?program=${p.id}`}
                    class="block rounded-lg bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 p-3 hover:shadow-sm transition-shadow no-underline"
                  >
                    <div class="font-medium text-sm text-neutral-900 dark:text-white">{p.name}</div>
                    <div class="text-xs text-neutral-700 dark:text-neutral-400 mt-0.5 line-clamp-1">
                      {p.description?.slice(0, 60)}...
                    </div>
                    <div class="text-xs text-primary-700 dark:text-primary-400 mt-1">{p.area}</div>
                  </a>
                ))
              }
            </div>
            <div
              class="rounded-lg bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 p-3 mb-3"
            >
              <div class="flex items-center gap-2 text-sm">
                <svg
                  class="w-4 h-4 text-red-600 dark:text-red-400 flex-shrink-0"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                  aria-hidden="true"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"
                  ></path></svg
                >
                <span class="text-red-900 dark:text-red-200"
                  >Facing eviction? Call the Eviction Defense Collaborative at <a
                    href="tel:14159470797"
                    class="font-bold underline">415-947-0797</a
                  ></span
                >
              </div>
            </div>
            <a
              href="/directory?category=Housing"
              class="text-sm font-medium text-primary-700 dark:text-primary-300 hover:text-primary-900 dark:hover:text-primary-100"
              >View all {housingCount} housing programs &rarr;</a
            >
          </div>
        </div>
      </div>

      <!-- HEALTH expand -->
      <div
        id="expand-health"
        class="expand-grid rounded-xl bg-primary-50/50 dark:bg-primary-900/20"
        data-open="false"
        role="region"
        aria-label="Health & Medical details"
      >
        <div class="expand-inner">
          <div class="p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-primary-900 dark:text-primary-200">Health & Medical</h3>
              <button
                class="expand-close text-sm font-medium text-primary-900 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 px-2 py-1 rounded-lg hover:bg-primary-100 dark:hover:bg-primary-900/30 transition-colors"
                data-expand="health"
                aria-label="Close health section">Close</button
              >
            </div>
            <div class="grid gap-3 sm:grid-cols-2 mb-4">
              {
                healthPrograms.map((p) => (
                  <a
                    href={`/directory?program=${p.id}`}
                    class="block rounded-lg bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 p-3 hover:shadow-sm transition-shadow no-underline"
                  >
                    <div class="font-medium text-sm text-neutral-900 dark:text-white">{p.name}</div>
                    <div class="text-xs text-neutral-700 dark:text-neutral-400 mt-0.5 line-clamp-1">
                      {p.description?.slice(0, 60)}...
                    </div>
                    <div class="text-xs text-primary-700 dark:text-primary-400 mt-1">{p.area}</div>
                  </a>
                ))
              }
            </div>
            <div
              class="rounded-lg bg-purple-50 dark:bg-purple-900/30 border border-purple-200 dark:border-purple-800 p-3 mb-3"
            >
              <div class="flex items-center gap-2 text-sm">
                <svg
                  class="w-4 h-4 text-purple-600 dark:text-purple-400 flex-shrink-0"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                  aria-hidden="true"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8.625 9.75a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375m-13.5 3.01c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.184-4.183a1.14 1.14 0 0 1 .778-.332 48.294 48.294 0 0 0 5.83-.498c1.585-.233 2.708-1.626 2.708-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z"
                  ></path></svg
                >
                <span class="text-purple-900 dark:text-purple-200"
                  >Need coverage? Apply for Medi-Cal at <a
                    href="https://www.coveredca.com"
                    target="_blank"
                    rel="noopener"
                    class="font-bold underline">coveredca.com</a
                  > or call <a href="tel:18003001506" class="font-bold underline">1-800-300-1506</a
                  ></span
                >
              </div>
            </div>
            <a
              href="/directory?category=Health"
              class="text-sm font-medium text-primary-700 dark:text-primary-300 hover:text-primary-900 dark:hover:text-primary-100"
              >View all {healthCount} health programs &rarr;</a
            >
          </div>
        </div>
      </div>

      <!-- JOBS expand -->
      <div
        id="expand-jobs"
        class="expand-grid rounded-xl bg-primary-50/50 dark:bg-primary-900/20"
        data-open="false"
        role="region"
        aria-label="Jobs & Legal details"
      >
        <div class="expand-inner">
          <div class="p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-primary-900 dark:text-primary-200">Jobs & Legal</h3>
              <button
                class="expand-close text-sm font-medium text-primary-900 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 px-2 py-1 rounded-lg hover:bg-primary-100 dark:hover:bg-primary-900/30 transition-colors"
                data-expand="jobs"
                aria-label="Close jobs section">Close</button
              >
            </div>
            <div class="grid gap-3 sm:grid-cols-2 mb-4">
              {
                jobsPrograms.map((p) => (
                  <a
                    href={`/directory?program=${p.id}`}
                    class="block rounded-lg bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 p-3 hover:shadow-sm transition-shadow no-underline"
                  >
                    <div class="font-medium text-sm text-neutral-900 dark:text-white">{p.name}</div>
                    <div class="text-xs text-neutral-700 dark:text-neutral-400 mt-0.5 line-clamp-1">
                      {p.description?.slice(0, 60)}...
                    </div>
                    <div class="text-xs text-primary-700 dark:text-primary-400 mt-1">{p.area}</div>
                  </a>
                ))
              }
            </div>
            {
              jobsGroups.length > 0 && (
                <div class="flex flex-wrap gap-1.5 mb-3">
                  <span class="text-xs text-neutral-700 dark:text-neutral-400 py-0.5">
                    Eligible if you're:
                  </span>
                  {jobsGroups.map((g) => (
                    <a
                      href={`/directory?category=Employment&group=${g.id}`}
                      class="text-xs bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 text-neutral-700 dark:text-neutral-300 px-2 py-0.5 rounded-full hover:border-primary-300 dark:hover:border-primary-600 hover:text-primary-700 dark:hover:text-primary-300 transition-colors no-underline"
                    >
                      {g.name}
                    </a>
                  ))}
                </div>
              )
            }
            <div
              class="rounded-lg bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 p-3 mb-3"
            >
              <div class="flex items-center gap-2 text-sm">
                <svg
                  class="w-4 h-4 text-amber-600 dark:text-amber-400 flex-shrink-0"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                  aria-hidden="true"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 0 0 .75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 0 0-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0 1 12 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 0 1-.673-.38m0 0A2.18 2.18 0 0 1 3 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 0 1 3.413-.387m7.5 0V5.25A2.25 2.25 0 0 0 13.5 3h-3a2.25 2.25 0 0 0-2.25 2.25v.894m7.5 0a48.667 48.667 0 0 0-7.5 0M12 12.75h.008v.008H12v-.008Z"
                  ></path></svg
                >
                <span class="text-amber-900 dark:text-amber-200"
                  >Unemployed? File for benefits at <a
                    href="https://edd.ca.gov"
                    target="_blank"
                    rel="noopener"
                    class="font-bold underline">edd.ca.gov</a
                  > or call <a href="tel:18003005616" class="font-bold underline">1-800-300-5616</a
                  ></span
                >
              </div>
            </div>
            <div
              class="rounded-lg bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-200 dark:border-indigo-800 p-3 mb-3"
            >
              <div class="flex items-center gap-2 text-sm">
                <svg
                  class="w-4 h-4 text-indigo-600 dark:text-indigo-400 flex-shrink-0"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                  aria-hidden="true"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z"
                  ></path></svg
                >
                <span class="text-indigo-900 dark:text-indigo-200"
                  >Free legal help &mdash; call Bay Area Legal Aid at <a
                    href="tel:18005515554"
                    class="font-bold underline">1-800-551-5554</a
                  ></span
                >
              </div>
            </div>
            <div class="flex flex-wrap gap-3">
              <a
                href="/directory?category=Employment"
                class="text-sm font-medium text-primary-700 dark:text-primary-300 hover:text-primary-900 dark:hover:text-primary-100"
                >View all {jobsCount} employment programs &rarr;</a
              >
              <span class="text-neutral-300 dark:text-neutral-600" aria-hidden="true">|</span>
              <a
                href="/directory?category=Legal%20Services"
                class="text-sm font-medium text-primary-700 dark:text-primary-300 hover:text-primary-900 dark:hover:text-primary-100"
                >View all {legalCount} legal programs &rarr;</a
              >
            </div>
          </div>
        </div>
      </div>

      <!-- More situations link -->
    </section>

    <!-- ======================================== -->
    <!-- BAY AREA LIVE -->
    <!-- ======================================== -->
    <section
      class="py-6 border-t border-neutral-200 dark:border-neutral-700"
      aria-labelledby="live-heading"
    >
      <h2
        id="live-heading"
        class="text-lg font-semibold text-neutral-800 dark:text-neutral-200 mb-3"
      >
        Bay Area Live
      </h2>

      <div class="grid gap-2.5 sm:grid-cols-2 lg:grid-cols-3">
        <!-- Transit -->
        <a
          href="/transit"
          class="group rounded-xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4 hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-sm transition-all no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-neutral-900"
        >
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/40 flex items-center justify-center"
                aria-hidden="true"
              >
                <svg
                  class="w-5 h-5 text-blue-600 dark:text-blue-400"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8.25 18.75a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 0 1-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 0 0-3.213-9.193 2.056 2.056 0 0 0-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 0 0-10.026 0 1.106 1.106 0 0 0-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12"
                  ></path></svg
                >
              </div>
              <span
                class="font-medium text-sm text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-300"
                >Transit</span
              >
            </div>
          </div>
          <div class="space-y-1.5">
            <div class="flex items-center gap-3 text-xs">
              <div class="flex items-center gap-1.5">
                <span
                  class="w-3 h-3 rounded-sm bg-blue-500 text-white text-[8px] flex items-center justify-center font-bold"
                  aria-hidden="true">B</span
                >
                <span class="text-neutral-700 dark:text-neutral-300">BART</span>
              </div>
              <div class="flex items-center gap-1.5">
                <span
                  class="w-3 h-3 rounded-sm bg-red-500 text-white text-[8px] flex items-center justify-center font-bold"
                  aria-hidden="true">M</span
                >
                <span class="text-neutral-700 dark:text-neutral-300">Muni</span>
              </div>
              <div class="flex items-center gap-1.5">
                <span
                  class="w-3 h-3 rounded-sm bg-orange-500 text-white text-[8px] flex items-center justify-center font-bold"
                  aria-hidden="true">C</span
                >
                <span class="text-neutral-700 dark:text-neutral-300">Caltrain</span>
              </div>
            </div>
            <p class="text-xs text-neutral-600 dark:text-neutral-400 mt-1.5">
              Real-time status for all systems
            </p>
          </div>
          <div
            class="mt-3 pt-2 border-t border-neutral-100 dark:border-neutral-700 text-xs text-neutral-700 dark:text-neutral-400"
          >
            Clipper discounts &middot; Paratransit &middot; Free ride programs
          </div>
        </a>

        <!-- Airports -->
        <a
          href="/airports"
          class="group rounded-xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4 hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-sm transition-all no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-neutral-900"
        >
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded-lg bg-orange-100 dark:bg-orange-900/40 flex items-center justify-center"
                aria-hidden="true"
              >
                <svg
                  class="w-5 h-5 text-orange-600 dark:text-orange-400"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"
                  ></path></svg
                >
              </div>
              <span
                class="font-medium text-sm text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-300"
                >Airports</span
              >
            </div>
          </div>
          <div class="flex items-center gap-3 text-sm">
            <span class="font-semibold text-neutral-900 dark:text-white">SFO</span>
            <span class="font-semibold text-neutral-900 dark:text-white">OAK</span>
            <span class="font-semibold text-neutral-900 dark:text-white">SJC</span>
          </div>
          <p class="text-xs text-neutral-600 dark:text-neutral-400 mt-1.5">
            Terminals, parking & real-time status
          </p>
          <div
            class="mt-3 pt-2 border-t border-neutral-100 dark:border-neutral-700 text-xs text-neutral-700 dark:text-neutral-400"
          >
            Ground transport &middot; Terminal maps &middot; Real-time status
          </div>
        </a>

        <!-- Alerts (loaded at runtime from blob storage) -->
        <a
          id="home-alerts-card"
          href="/alerts"
          class="group rounded-xl border border-red-100 dark:border-red-900 bg-white dark:bg-neutral-800 p-4 hover:border-red-300 dark:hover:border-red-700 hover:shadow-sm transition-all no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-red-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-neutral-900"
        >
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded-lg bg-red-100 dark:bg-red-900/40 flex items-center justify-center"
                aria-hidden="true"
              >
                <svg
                  class="w-5 h-5 text-red-600 dark:text-red-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                  aria-hidden="true"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
                  ></path></svg
                >
              </div>
              <span
                class="font-medium text-sm text-neutral-900 dark:text-white group-hover:text-red-700 dark:group-hover:text-red-300"
                >Alerts</span
              >
            </div>
            <div id="home-alerts-badge" class="hidden flex items-center gap-1">
              <span class="w-1.5 h-1.5 bg-red-500 rounded-full pulse-dot" aria-hidden="true"></span>
              <span
                id="home-alerts-badge-text"
                class="text-xs text-red-600 dark:text-red-400 font-medium"></span>
            </div>
          </div>
          <div id="home-alerts-cases" class="space-y-2">
            <p class="text-xs text-neutral-700 dark:text-neutral-400">Loading alerts...</p>
          </div>
          <div
            class="mt-3 pt-2 border-t border-neutral-100 dark:border-neutral-700 text-xs text-red-600 dark:text-red-400 font-medium"
          >
            View all alerts &middot; 1-800-THE-LOST
          </div>
        </a>

        <!-- Eligibility Guide -->
        <a
          href="/eligibility"
          class="group rounded-xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4 hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-sm transition-all no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-neutral-900"
        >
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded-lg bg-emerald-100 dark:bg-emerald-900/40 flex items-center justify-center"
                aria-hidden="true"
              >
                <svg
                  class="w-5 h-5 text-emerald-600 dark:text-emerald-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                  aria-hidden="true"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path></svg
                >
              </div>
              <span
                class="font-medium text-sm text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-300"
                >Eligibility Guide</span
              >
            </div>
          </div>
          <p class="text-xs text-neutral-700 dark:text-neutral-400 mb-2">
            Answer a few quick questions to find programs you may qualify for &mdash; no personal
            info stored.
          </p>
          <div class="flex flex-wrap gap-1.5">
            {
              groups
                .slice(0, 4)
                .map((g) => (
                  <span class="text-xs bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-400 px-2 py-0.5 rounded-full">
                    {g.name}
                  </span>
                ))
            }
            {
              groups.length > 4 && (
                <span class="text-xs bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-400 px-2 py-0.5 rounded-full">
                  +{groups.length - 4} more
                </span>
              )
            }
          </div>
          <div
            class="mt-3 pt-2 border-t border-neutral-100 dark:border-neutral-700 text-xs text-primary-700 dark:text-primary-400 font-medium"
          >
            Start the guide &mdash; takes 2 minutes
          </div>
        </a>

        <!-- My City -->
        <a
          href="/directory"
          class="group rounded-xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4 hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-sm transition-all no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-neutral-900"
        >
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded-lg bg-primary-100 dark:bg-primary-900/40 flex items-center justify-center"
                aria-hidden="true"
              >
                <svg
                  class="w-5 h-5 text-primary-700 dark:text-primary-400"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"
                  ></path></svg
                >
              </div>
              <span
                class="font-medium text-sm text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-300"
                >My City</span
              >
            </div>
            <span
              class="text-[10px] font-medium uppercase tracking-wide bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-400 px-2 py-0.5 rounded-full"
              >Coming soon</span
            >
          </div>
          <p class="text-xs text-neutral-600 dark:text-neutral-400">
            Council meetings, local news & community events
          </p>
          <div
            class="mt-3 pt-2 border-t border-neutral-100 dark:border-neutral-700 text-xs text-neutral-700 dark:text-neutral-400"
          >
            Budgets &middot; Public safety &middot; Zoning &middot; Elections
          </div>
        </a>

        <!-- Explore -->
        <a
          href="/directory"
          class="group rounded-xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4 hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-sm transition-all no-underline focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-neutral-900"
        >
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/40 flex items-center justify-center"
                aria-hidden="true"
              >
                <svg
                  class="w-5 h-5 text-violet-600 dark:text-violet-400"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"
                  ></path></svg
                >
              </div>
              <span
                class="font-medium text-sm text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-300"
                >Explore</span
              >
            </div>
          </div>
          <p class="text-xs text-neutral-600 dark:text-neutral-400">
            {totalPrograms} programs, open data, municipal codes & Bay Area map
          </p>
          <div
            class="mt-3 pt-2 border-t border-neutral-100 dark:border-neutral-700 text-xs text-neutral-700 dark:text-neutral-400"
          >
            For researchers, advocates & curious minds
          </div>
        </a>
      </div>
    </section>

    <!-- ======================================== -->
    <!-- CRISIS FOOTER — always visible, never hidden -->
    <!-- ======================================== -->
    <section
      class="py-6 border-t border-neutral-200 dark:border-neutral-700"
      aria-labelledby="crisis-heading"
    >
      <div class="rounded-xl bg-neutral-900 dark:bg-neutral-950 text-white p-5">
        <h2 id="crisis-heading" class="font-semibold mb-3">In crisis? Help is available now.</h2>
        <div class="grid gap-3 sm:grid-cols-3">
          <div>
            <div class="text-sm font-medium text-neutral-300">Suicide & Crisis</div>
            <a
              href="tel:988"
              class="text-lg font-bold text-white hover:text-primary-300 transition-colors"
              >Call or text 988</a
            >
            <div class="text-xs text-neutral-400">24/7, free, confidential</div>
          </div>
          <div>
            <div class="text-sm font-medium text-neutral-300">Any Need</div>
            <a
              href="tel:211"
              class="text-lg font-bold text-white hover:text-primary-300 transition-colors"
              >Call 2-1-1</a
            >
            <div class="text-xs text-neutral-400">Food, shelter, utilities, more</div>
          </div>
          <div>
            <div class="text-sm font-medium text-neutral-300">Domestic Violence</div>
            <a
              href="tel:18007997233"
              class="text-lg font-bold text-white hover:text-primary-300 transition-colors"
              >1-800-799-7233</a
            >
            <div class="text-xs text-neutral-400">National DV Hotline, 24/7</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Interactive behaviors: search, expand/collapse, location combobox -->
  <script define:vars={{ typesenseBaseUrl, typesenseSearchKey, totalPrograms }}>
    (function () {
      // --- Expand / Collapse Situation Cards ---
      var currentOpen = null;

      function toggleExpand(id) {
        var el = document.getElementById('expand-' + id);
        if (!el) return;

        var btn = document.querySelector('[aria-controls="expand-' + id + '"]');

        if (currentOpen && currentOpen !== id) {
          var prev = document.getElementById('expand-' + currentOpen);
          var prevBtn = document.querySelector('[aria-controls="expand-' + currentOpen + '"]');
          if (prev) prev.setAttribute('data-open', 'false');
          if (prevBtn) prevBtn.setAttribute('aria-expanded', 'false');
        }

        var isOpen = el.getAttribute('data-open') === 'true';
        if (isOpen) {
          el.setAttribute('data-open', 'false');
          if (btn) btn.setAttribute('aria-expanded', 'false');
          currentOpen = null;
        } else {
          el.setAttribute('data-open', 'true');
          if (btn) btn.setAttribute('aria-expanded', 'true');
          currentOpen = id;
          setTimeout(function () {
            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 120);
        }
      }

      // Handle situation card buttons
      document.querySelectorAll('button[data-expand]').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var id = btn.getAttribute('data-expand');
          if (id) toggleExpand(id);
        });
      });

      // --- Search Mode Toggle (Browse / Ask Carl) ---
      var browseBtn = document.getElementById('mode-browse');
      var carlBtn = document.getElementById('mode-carl');

      function setSearchMode(mode) {
        var input = document.getElementById('search-input');
        var hint = document.getElementById('mode-hint');
        var badge = document.getElementById('carl-badge');

        if (mode === 'carl') {
          browseBtn.setAttribute('aria-pressed', 'false');
          carlBtn.setAttribute('aria-pressed', 'true');
          input.placeholder =
            'Ask Carl: "Can I keep chickens in San Jose?" or "rent help near 94102"';
          if (hint) hint.textContent = 'Carl searches ' + totalPrograms + '+ programs for you';
          if (badge) {
            badge.classList.remove('hidden');
            badge.classList.add('inline-flex');
          }
        } else {
          browseBtn.setAttribute('aria-pressed', 'true');
          carlBtn.setAttribute('aria-pressed', 'false');
          input.placeholder = 'Try: "food banks near me" or "help paying my electric bill"';
          if (hint) hint.textContent = 'Search by category or keyword';
          if (badge) {
            badge.classList.add('hidden');
            badge.classList.remove('inline-flex');
          }
        }
      }

      // Auto-detect conversational queries and show Carl badge
      var CARL_PATTERNS =
        /\?|^(how|where|what|who|when|why|can i|do i|am i|is there|are there|tell me|help me|i need|i'm|i am|show me)/i;

      function detectSearchMode(query) {
        return CARL_PATTERNS.test(query.trim()) ? 'carl' : 'browse';
      }

      var searchInputEl = document.getElementById('search-input');
      if (searchInputEl) {
        searchInputEl.addEventListener('input', function () {
          var detected = detectSearchMode(searchInputEl.value);
          setSearchMode(detected);
        });
      }

      // Keep click handlers for backward compatibility (hidden buttons)
      if (browseBtn)
        browseBtn.addEventListener('click', function () {
          setSearchMode('browse');
        });
      if (carlBtn)
        carlBtn.addEventListener('click', function () {
          setSearchMode('carl');
        });

      // --- Typesense Search ---
      function searchViaTypesense(query, options) {
        options = options || {};
        var limit = options.limit || 12;
        var params = new URLSearchParams({
          q: query,
          query_by: 'name,keywords,description',
          per_page: String(limit),
          num_typos: '2',
          typo_tokens_threshold: '1',
        });

        return fetch(
          typesenseBaseUrl + '/collections/programs/documents/search?' + params.toString(),
          {
            signal: AbortSignal.timeout(5000),
            headers: { 'X-TYPESENSE-API-KEY': typesenseSearchKey },
          }
        )
          .then(function (resp) {
            if (!resp.ok) throw new Error('Typesense ' + resp.status);
            return resp.json();
          })
          .then(function (data) {
            return (data.hits || []).map(function (hit) {
              return {
                id: hit.document.id,
                name: hit.document.name || '',
                description: hit.document.description || '',
                category: hit.document.category || '',
                area: hit.document.area || '',
                city: hit.document.city || '',
                phone: hit.document.phone || '',
                link: hit.document.link || '',
              };
            });
          });
      }

      // --- Search Results Rendering (safe DOM methods only) ---
      function renderSearchResults(results, query, location) {
        var hero = document.getElementById('hero-section');
        if (!hero) return;
        var existing = document.getElementById('search-results-section');
        if (existing) existing.remove();

        var section = document.createElement('div');
        section.id = 'search-results-section';
        section.className = 'mt-6 mb-4';

        var header = document.createElement('div');
        header.className = 'flex items-center justify-between mb-4 gap-3';

        var headerLeft = document.createElement('div');
        var heading = document.createElement('h2');
        heading.className = 'text-lg font-bold text-neutral-900 dark:text-white';
        heading.textContent = location
          ? 'Results for "' + query + '" in ' + location
          : 'Results for "' + query + '"';
        headerLeft.appendChild(heading);

        var countText = document.createElement('p');
        countText.className = 'text-sm text-neutral-700 dark:text-neutral-400';
        countText.textContent =
          results.length + ' program' + (results.length !== 1 ? 's' : '') + ' found';
        headerLeft.appendChild(countText);

        var closeBtn = document.createElement('button');
        closeBtn.className =
          'text-neutral-700 hover:text-neutral-900 dark:hover:text-neutral-200 flex-shrink-0 p-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors';
        closeBtn.setAttribute('aria-label', 'Clear search results');
        closeBtn.addEventListener('click', function () {
          section.remove();
        });
        var closeSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        closeSvg.setAttribute('class', 'w-5 h-5');
        closeSvg.setAttribute('fill', 'none');
        closeSvg.setAttribute('viewBox', '0 0 24 24');
        closeSvg.setAttribute('stroke', 'currentColor');
        closeSvg.setAttribute('stroke-width', '2');
        var closePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        closePath.setAttribute('stroke-linecap', 'round');
        closePath.setAttribute('stroke-linejoin', 'round');
        closePath.setAttribute('d', 'M6 18L18 6M6 6l12 12');
        closeSvg.appendChild(closePath);
        closeBtn.appendChild(closeSvg);

        header.appendChild(headerLeft);
        header.appendChild(closeBtn);
        section.appendChild(header);

        var grid = document.createElement('div');
        grid.className = 'grid gap-3 sm:grid-cols-2 lg:grid-cols-3';

        results.forEach(function (r) {
          var card = document.createElement('a');
          card.href = r.link || '/directory?program=' + encodeURIComponent(r.id);
          if (r.link) card.target = '_blank';
          card.rel = 'noopener';
          card.className =
            'group block rounded-xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4 hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-md transition-all no-underline';

          if (r.category) {
            var pill = document.createElement('span');
            pill.className =
              'inline-block text-[11px] font-medium uppercase tracking-wide text-primary-900 dark:text-primary-300 bg-primary-50 dark:bg-primary-900/40 px-2 py-0.5 rounded-md mb-2';
            pill.textContent = r.category;
            card.appendChild(pill);
          }

          var name = document.createElement('h3');
          name.className =
            'font-semibold text-neutral-900 dark:text-white group-hover:text-primary-700 dark:group-hover:text-primary-300 transition-colors leading-tight';
          name.textContent = r.name;
          card.appendChild(name);

          if (r.description) {
            var desc = document.createElement('p');
            desc.className = 'text-sm text-neutral-700 dark:text-neutral-400 mt-1 line-clamp-2';
            desc.textContent = r.description;
            card.appendChild(desc);
          }

          var meta = r.area || r.city;
          if (meta) {
            var metaRow = document.createElement('div');
            metaRow.className =
              'flex items-center gap-1.5 mt-2 text-xs text-neutral-700 dark:text-neutral-500';
            var pinSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            pinSvg.setAttribute('class', 'w-3.5 h-3.5 flex-shrink-0');
            pinSvg.setAttribute('fill', 'none');
            pinSvg.setAttribute('viewBox', '0 0 24 24');
            pinSvg.setAttribute('stroke', 'currentColor');
            pinSvg.setAttribute('stroke-width', '1.5');
            var pinPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            pinPath.setAttribute('stroke-linecap', 'round');
            pinPath.setAttribute('stroke-linejoin', 'round');
            pinPath.setAttribute('d', 'M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z');
            pinSvg.appendChild(pinPath);
            var pinPath2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            pinPath2.setAttribute('stroke-linecap', 'round');
            pinPath2.setAttribute('stroke-linejoin', 'round');
            pinPath2.setAttribute(
              'd',
              'M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z'
            );
            pinSvg.appendChild(pinPath2);
            metaRow.appendChild(pinSvg);
            var metaSpan = document.createElement('span');
            metaSpan.textContent = meta;
            metaRow.appendChild(metaSpan);
            card.appendChild(metaRow);
          }

          if (r.phone) {
            var phoneRow = document.createElement('div');
            phoneRow.className =
              'flex items-center gap-1.5 mt-1 text-xs text-neutral-700 dark:text-neutral-500';
            var phoneSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            phoneSvg.setAttribute('class', 'w-3.5 h-3.5 flex-shrink-0');
            phoneSvg.setAttribute('fill', 'none');
            phoneSvg.setAttribute('viewBox', '0 0 24 24');
            phoneSvg.setAttribute('stroke', 'currentColor');
            phoneSvg.setAttribute('stroke-width', '1.5');
            var phonePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            phonePath.setAttribute('stroke-linecap', 'round');
            phonePath.setAttribute('stroke-linejoin', 'round');
            phonePath.setAttribute(
              'd',
              'M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z'
            );
            phoneSvg.appendChild(phonePath);
            phoneRow.appendChild(phoneSvg);
            var phoneLink = document.createElement('a');
            phoneLink.href = 'tel:' + r.phone.replace(/[^0-9+]/g, '');
            phoneLink.className =
              'text-primary-700 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-200 hover:underline';
            phoneLink.textContent = r.phone;
            phoneLink.addEventListener('click', function (e) {
              e.stopPropagation();
            });
            phoneRow.appendChild(phoneLink);
            card.appendChild(phoneRow);
          }

          grid.appendChild(card);
        });

        section.appendChild(grid);

        var suggestion = document.createElement('div');
        suggestion.className = 'mt-4 text-center text-sm text-neutral-700 dark:text-neutral-500';
        suggestion.textContent =
          'Not finding what you need? Try Ask Carl for a more specific search.';
        section.appendChild(suggestion);

        hero.parentNode.insertBefore(section, hero.nextSibling);
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function renderSearchLoading(query, location) {
        var hero = document.getElementById('hero-section');
        if (!hero) return;
        var existing = document.getElementById('search-results-section');
        if (existing) existing.remove();

        var section = document.createElement('div');
        section.id = 'search-results-section';
        section.className = 'mt-6 mb-4';

        var loading = document.createElement('div');
        loading.className =
          'rounded-xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-8 text-center';

        var spinner = document.createElement('div');
        spinner.className =
          'inline-block w-6 h-6 border-2 border-primary-200 dark:border-primary-800 border-t-primary-600 dark:border-t-primary-400 rounded-full animate-spin mb-3';
        loading.appendChild(spinner);

        var text = document.createElement('p');
        text.className = 'text-sm text-neutral-700 dark:text-neutral-400';
        text.textContent = location
          ? 'Searching for "' + query + '" in ' + location + '\u2026'
          : 'Searching for "' + query + '"\u2026';
        loading.appendChild(text);

        section.appendChild(loading);
        hero.parentNode.insertBefore(section, hero.nextSibling);
      }

      function renderSearchError() {
        var hero = document.getElementById('hero-section');
        if (!hero) return;
        var existing = document.getElementById('search-results-section');
        if (existing) existing.remove();

        var section = document.createElement('div');
        section.id = 'search-results-section';
        section.className = 'mt-6 mb-4';

        var banner = document.createElement('div');
        banner.className =
          'rounded-xl border border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/30 p-4';

        var inner = document.createElement('div');
        inner.className = 'flex items-start gap-3';

        var warnSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        warnSvg.setAttribute(
          'class',
          'w-5 h-5 text-amber-600 dark:text-amber-400 flex-shrink-0 mt-0.5'
        );
        warnSvg.setAttribute('fill', 'none');
        warnSvg.setAttribute('viewBox', '0 0 24 24');
        warnSvg.setAttribute('stroke', 'currentColor');
        warnSvg.setAttribute('stroke-width', '1.5');
        var warnPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        warnPath.setAttribute('stroke-linecap', 'round');
        warnPath.setAttribute('stroke-linejoin', 'round');
        warnPath.setAttribute(
          'd',
          'M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z'
        );
        warnSvg.appendChild(warnPath);
        inner.appendChild(warnSvg);

        var textDiv = document.createElement('div');
        var title = document.createElement('p');
        title.className = 'text-sm font-medium text-amber-800 dark:text-amber-200';
        title.textContent = 'Search is temporarily unavailable';
        textDiv.appendChild(title);

        var desc = document.createElement('p');
        desc.className = 'text-sm text-amber-700 dark:text-amber-300 mt-1';
        desc.textContent =
          'Try browsing by category below, or Ask Carl for help finding what you need.';
        textDiv.appendChild(desc);
        inner.appendChild(textDiv);

        var closeBtn = document.createElement('button');
        closeBtn.className =
          'text-amber-600 dark:text-amber-400 hover:text-amber-800 dark:hover:text-amber-200 flex-shrink-0 p-1 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/40 transition-colors ml-auto';
        closeBtn.setAttribute('aria-label', 'Dismiss');
        closeBtn.addEventListener('click', function () {
          section.remove();
        });
        var closeSvg2 = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        closeSvg2.setAttribute('class', 'w-4 h-4');
        closeSvg2.setAttribute('fill', 'none');
        closeSvg2.setAttribute('viewBox', '0 0 24 24');
        closeSvg2.setAttribute('stroke', 'currentColor');
        closeSvg2.setAttribute('stroke-width', '2');
        var closePath2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        closePath2.setAttribute('stroke-linecap', 'round');
        closePath2.setAttribute('stroke-linejoin', 'round');
        closePath2.setAttribute('d', 'M6 18L18 6M6 6l12 12');
        closeSvg2.appendChild(closePath2);
        closeBtn.appendChild(closeSvg2);
        inner.appendChild(closeBtn);

        banner.appendChild(inner);
        section.appendChild(banner);
        hero.parentNode.insertBefore(section, hero.nextSibling);
      }

      // --- Search Handler ---
      function handleSearch() {
        var input = document.getElementById('search-input');
        var query = input ? input.value.trim() : '';
        if (!query) {
          if (input) input.focus();
          return;
        }

        var locationInput = document.getElementById('location-input');
        var location = locationInput ? locationInput.value.trim() : '';

        var cleanQuery = query;
        if (location) {
          cleanQuery = query.replace(/\s*near\s+me\s*/gi, ' ').trim();
          if (!cleanQuery) cleanQuery = query;
        }

        var isCarlMode = carlBtn && carlBtn.getAttribute('aria-pressed') === 'true';

        if (isCarlMode) {
          // Trigger the SmartAssistant (Carl) — dispatch custom event
          var carlMessage = location ? cleanQuery + ' near ' + location : query;
          var event = new CustomEvent('carl-ask', { detail: { message: carlMessage } });
          document.dispatchEvent(event);
          // Also try opening the smart assistant
          var askCarlBtn = document.querySelector('[data-smart-assistant-trigger]');
          if (askCarlBtn) askCarlBtn.click();
        } else {
          var displayQuery = location ? cleanQuery : query;
          renderSearchLoading(displayQuery, location);

          searchViaTypesense(displayQuery)
            .then(function (results) {
              renderSearchResults(results, displayQuery, location);
            })
            .catch(function (err) {
              console.warn('Search failed:', err.message);
              renderSearchError();
            });
        }
      }

      // Search input Enter key
      var searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleSearch();
          }
        });
      }

      // Search submit button
      var submitBtn = document.getElementById('search-submit-btn');
      if (submitBtn) {
        submitBtn.addEventListener('click', function () {
          handleSearch();
        });
      }

      // --- Location Combobox ---
      var BAY_AREA_CITIES = [
        'San Jose',
        'San Francisco',
        'Oakland',
        'Fremont',
        'Hayward',
        'Sunnyvale',
        'Santa Clara',
        'Concord',
        'Berkeley',
        'Richmond',
        'Daly City',
        'San Mateo',
        'Redwood City',
        'Mountain View',
        'Palo Alto',
        'Milpitas',
        'Walnut Creek',
        'Alameda',
        'San Leandro',
        'Livermore',
        'Pleasanton',
        'Union City',
        'Cupertino',
        'San Ramon',
        'Dublin',
        'Campbell',
        'South San Francisco',
        'Santa Rosa',
        'Vallejo',
        'Antioch',
      ];

      function filterLocations() {
        var input = document.getElementById('location-input');
        var dropdown = document.getElementById('location-dropdown');
        if (!input || !dropdown) return;
        var query = input.value.trim().toLowerCase();

        while (dropdown.firstChild) {
          dropdown.removeChild(dropdown.firstChild);
        }

        var filtered = BAY_AREA_CITIES.filter(function (city) {
          return !query || city.toLowerCase().indexOf(query) !== -1;
        }).slice(0, 8);

        if (filtered.length === 0) {
          dropdown.setAttribute('data-open', 'false');
          input.setAttribute('aria-expanded', 'false');
          return;
        }

        filtered.forEach(function (city) {
          var option = document.createElement('div');
          option.className =
            'w-full text-left text-sm px-4 py-2.5 hover:bg-primary-50 dark:hover:bg-primary-900/30 text-neutral-700 dark:text-neutral-300 hover:text-primary-700 dark:hover:text-primary-300 transition-colors cursor-pointer';
          option.setAttribute('role', 'option');
          option.setAttribute('aria-selected', 'false');
          option.textContent = city;
          option.addEventListener('click', function () {
            input.value = city;
            dropdown.setAttribute('data-open', 'false');
            input.setAttribute('aria-expanded', 'false');
          });
          dropdown.appendChild(option);
        });

        dropdown.setAttribute('data-open', 'true');
        input.setAttribute('aria-expanded', 'true');
      }

      var locInput = document.getElementById('location-input');
      if (locInput) {
        locInput.addEventListener('focus', filterLocations);
        locInput.addEventListener('input', filterLocations);
      }

      // Detect location button
      var detectBtn = document.getElementById('detect-location-btn');
      if (detectBtn) {
        detectBtn.addEventListener('click', function () {
          var input = document.getElementById('location-input');
          if (!input) return;
          input.value = 'Detecting\u2026';
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              function (pos) {
                // Reverse geocode would go here; for now use a placeholder
                input.value = 'Near me';
              },
              function () {
                input.value = '';
                input.placeholder = 'Location unavailable';
              },
              { timeout: 5000 }
            );
          } else {
            input.value = '';
          }
        });
      }

      // Close location dropdown on outside click
      document.addEventListener('click', function (e) {
        var locInput = document.getElementById('location-input');
        var dropdown = document.getElementById('location-dropdown');
        if (locInput && dropdown && !locInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.setAttribute('data-open', 'false');
          locInput.setAttribute('aria-expanded', 'false');
        }
      });

      // Close panels on Escape
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && currentOpen) {
          var el = document.getElementById('expand-' + currentOpen);
          var btn = document.querySelector('[aria-controls="expand-' + currentOpen + '"]');
          if (el) el.setAttribute('data-open', 'false');
          if (btn) btn.setAttribute('aria-expanded', 'false');
          currentOpen = null;
        }
      });
    })();
  </script>

  <style>
    .home-page {
      position: relative;
      padding-top: 0.75rem;
      padding-bottom: 1.25rem;
    }

    .home-page::before {
      content: '';
      position: absolute;
      inset: 0 0 auto 0;
      height: 28rem;
      background:
        radial-gradient(circle at 12% 8%, rgba(17, 125, 178, 0.16), transparent 36%),
        radial-gradient(circle at 88% 0%, rgba(232, 169, 53, 0.16), transparent 30%),
        linear-gradient(180deg, rgba(255, 255, 255, 0.9), rgba(247, 248, 250, 0));
      pointer-events: none;
      z-index: 0;
    }

    :global(.dark) .home-page::before {
      background:
        radial-gradient(circle at 15% 12%, rgba(37, 154, 214, 0.2), transparent 42%),
        radial-gradient(circle at 88% 2%, rgba(212, 143, 24, 0.18), transparent 34%),
        linear-gradient(180deg, rgba(15, 23, 32, 0.6), rgba(15, 23, 32, 0));
    }

    .home-page > * {
      position: relative;
      z-index: 1;
    }

    .home-hero {
      margin-top: 0.5rem;
      border-radius: 1.5rem;
      border: 1px solid rgba(172, 203, 219, 0.75);
      padding: 2.25rem 1.5rem 1.25rem;
      background:
        radial-gradient(circle at 84% 16%, rgba(232, 169, 53, 0.18), transparent 42%),
        radial-gradient(circle at 12% 84%, rgba(88, 158, 196, 0.2), transparent 46%),
        linear-gradient(160deg, #f7fbff 0%, #eef6fb 44%, #f8fafc 100%);
      box-shadow: 0 20px 36px rgba(17, 73, 104, 0.12);
    }

    :global(.dark) .home-hero {
      border-color: rgba(111, 150, 173, 0.44);
      background:
        radial-gradient(circle at 84% 16%, rgba(212, 143, 24, 0.2), transparent 42%),
        radial-gradient(circle at 12% 84%, rgba(26, 100, 137, 0.34), transparent 46%),
        linear-gradient(160deg, #1a2733 0%, #182331 40%, #0f1720 100%);
      box-shadow: 0 24px 44px rgba(0, 0, 0, 0.35);
    }

    .home-page #search-heading {
      letter-spacing: -0.022em;
      text-wrap: balance;
    }

    .home-search-shell {
      backdrop-filter: blur(8px);
      background: rgba(255, 255, 255, 0.92);
      border-color: rgba(200, 216, 228, 0.95);
    }

    :global(.dark) .home-search-shell {
      background: rgba(26, 36, 51, 0.9);
      border-color: rgba(102, 123, 147, 0.65);
    }

    .home-page .pill-scroll-container {
      margin-top: 0.85rem;
      border-radius: 1rem;
      border: 1px solid rgba(216, 229, 237, 0.9);
      padding: 0.65rem 0.75rem;
      background: rgba(255, 255, 255, 0.72);
      backdrop-filter: blur(6px);
    }

    :global(.dark) .home-page .pill-scroll-container {
      border-color: rgba(74, 88, 106, 0.9);
      background: rgba(26, 36, 51, 0.72);
    }

    .home-page .pill-scroll-container a {
      border-color: rgba(193, 208, 220, 0.9);
      background: rgba(247, 248, 250, 0.9);
    }

    :global(.dark) .home-page .pill-scroll-container a {
      border-color: rgba(82, 99, 119, 0.88);
      background: rgba(26, 36, 51, 0.92);
    }

    .home-page section[aria-label='Crisis resources'] {
      border-radius: 0.95rem;
      border-color: rgba(232, 169, 53, 0.38);
      background: linear-gradient(
        130deg,
        rgba(254, 243, 224, 0.86) 0%,
        rgba(255, 249, 240, 0.94) 100%
      );
      box-shadow: 0 8px 20px rgba(140, 87, 16, 0.08);
    }

    :global(.dark) .home-page section[aria-label='Crisis resources'] {
      border-color: rgba(212, 143, 24, 0.52);
      background: linear-gradient(130deg, rgba(74, 46, 13, 0.44) 0%, rgba(39, 30, 17, 0.4) 100%);
      box-shadow: none;
    }

    .home-page section[aria-labelledby='situations-heading'] {
      margin-top: 1rem;
      padding: 1rem;
      border: 1px solid rgba(219, 228, 236, 0.92);
      border-radius: 1.1rem;
      background: rgba(255, 255, 255, 0.83);
      backdrop-filter: blur(4px);
    }

    :global(.dark) .home-page section[aria-labelledby='situations-heading'] {
      border-color: rgba(76, 95, 114, 0.86);
      background: rgba(20, 30, 41, 0.85);
    }

    .home-page section[aria-labelledby='live-heading'] {
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top-color: rgba(206, 219, 229, 0.95);
    }

    :global(.dark) .home-page section[aria-labelledby='live-heading'] {
      border-top-color: rgba(72, 90, 108, 0.92);
    }

    .home-page section[aria-labelledby='crisis-heading'] {
      border-top-color: rgba(206, 219, 229, 0.95);
    }

    :global(.dark) .home-page section[aria-labelledby='crisis-heading'] {
      border-top-color: rgba(72, 90, 108, 0.92);
    }

    .home-page section[aria-labelledby='crisis-heading'] > div {
      border: 1px solid rgba(37, 154, 214, 0.28);
      box-shadow: 0 18px 30px rgba(7, 22, 36, 0.34);
      background:
        radial-gradient(circle at 92% 0%, rgba(26, 100, 137, 0.35), transparent 50%),
        linear-gradient(160deg, #0b1925 0%, #0f2231 48%, #0f1720 100%);
    }

    /* --- Situation card hover/active --- */
    .home-page .situation-card {
      transition:
        transform 0.2s ease,
        box-shadow 0.2s ease,
        border-color 0.2s ease;
    }
    .home-page .situation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 20px rgba(22, 58, 81, 0.11);
    }
    .home-page .situation-card[aria-expanded='true'] {
      border-color: var(--color-primary-500, #1a6489);
      box-shadow: 0 0 0 2px rgba(26, 100, 137, 0.15);
    }

    /* Icon hover/tap micro-interaction */
    .home-page .situation-card svg {
      transition: transform 0.2s cubic-bezier(0.32, 0.72, 0, 1);
    }
    .home-page .situation-card:hover svg {
      transform: scale(1.08);
    }
    .home-page .situation-card:active svg {
      transform: scale(0.95);
    }

    /* --- Search bar glow --- */
    .home-page .search-glow:focus-within {
      box-shadow:
        0 0 0 3px rgba(26, 79, 110, 0.16),
        0 16px 28px rgba(17, 73, 104, 0.18);
      border-color: var(--color-primary-500, #1a6489);
    }
    :global(.dark) .home-page .search-glow:focus-within {
      box-shadow: 0 0 0 3px rgba(26, 79, 110, 0.35);
    }

    /* --- Search input placeholder fade on focus --- */
    .search-input::placeholder {
      transition: opacity 0.15s;
    }
    .search-input:focus::placeholder {
      opacity: 0.5;
    }

    /* --- CSS Grid expand animation --- */
    .home-page .expand-grid {
      display: grid;
      grid-template-rows: 0fr;
      border: 1px solid transparent;
      margin-top: 0;
      transition:
        grid-template-rows 0.35s ease,
        margin-top 0.35s ease,
        border-color 0.35s ease;
    }
    .home-page .expand-grid[data-open='true'] {
      grid-template-rows: 1fr;
      border-color: oklch(0.8 0.04 250);
      margin-top: 1rem;
    }
    :is(.dark) .home-page .expand-grid[data-open='true'] {
      border-color: oklch(0.35 0.04 250);
    }
    .home-page .expand-grid > .expand-inner {
      overflow: hidden;
    }

    /* --- Alert dot pulse --- */
    @keyframes pulse-dot {
      0%,
      100% {
        opacity: 1;
      }
      50% {
        opacity: 0.4;
      }
    }
    .pulse-dot {
      animation: pulse-dot 2s ease-in-out infinite;
    }

    /* --- Mode toggle (Browse / Ask Carl) --- */
    .mode-toggle {
      position: relative;
      display: inline-flex;
      background: var(--color-neutral-100, #f5f5f5);
      border-radius: 9999px;
      padding: 3px;
    }
    :global(.dark) .mode-toggle {
      background: var(--color-neutral-700, #3d3d3d);
    }
    .mode-toggle-btn {
      position: relative;
      z-index: 1;
      padding: 0.375rem 1rem;
      font-size: 0.8125rem;
      font-weight: 500;
      border-radius: 9999px;
      transition:
        color 0.2s ease,
        background 0.2s ease;
      color: var(--color-neutral-500, #5c5c5c);
      cursor: pointer;
      border: none;
      background: transparent;
      white-space: nowrap;
    }
    :global(.dark) .mode-toggle-btn {
      color: var(--color-neutral-400, #a3a3a3);
    }
    .mode-toggle-btn[aria-pressed='true'] {
      color: #fff;
      background: var(--color-primary-700, #1a4f6e);
    }

    /* --- Location combobox dropdown --- */
    .location-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 50;
      background: #fff;
      border: 1px solid var(--color-neutral-300, #d4d4d4);
      border-radius: 0.75rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      margin-top: 0.25rem;
      max-height: 14rem;
      overflow-y: auto;
      display: none;
    }
    :global(.dark) .location-dropdown {
      background: var(--color-neutral-800, #262626);
      border-color: var(--color-neutral-600, #4a4a4a);
    }
    .location-dropdown[data-open='true'] {
      display: block;
    }

    /* --- Contextual pill scroll fade --- */
    .home-page .pill-scroll-container {
      position: relative;
    }
    .home-page .pill-scroll-container::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 3rem;
      background: linear-gradient(to right, transparent, var(--color-neutral-50, #fafafa));
      pointer-events: none;
    }
    :global(.dark) .home-page .pill-scroll-container::after {
      background: linear-gradient(to right, transparent, var(--color-neutral-900, #171717));
    }

    /* --- Scrollbar hide for horizontal scroll --- */
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    /* --- Reduced motion --- */
    @media (prefers-reduced-motion: reduce) {
      .home-page .situation-card:hover {
        transform: none;
      }
      .home-page .situation-card svg {
        transition: none !important;
      }
      .home-page .situation-card:hover svg,
      .home-page .situation-card:active svg {
        transform: none !important;
      }
      .home-page .expand-grid {
        transition: none;
      }
      .pulse-dot {
        animation: none;
      }
    }

    /* --- High-contrast mode support --- */
    @media (forced-colors: active) {
      .home-page .situation-card {
        border: 2px solid ButtonText;
      }
      .mode-toggle-btn[aria-pressed='true'] {
        forced-color-adjust: none;
      }
    }
  </style>

  <script>
    // Populate the alerts card on the homepage from blob storage.
    // Note: innerHTML usage below is for static SVG icons only, not dynamic data.
    (async function () {
      const container = document.getElementById('home-alerts-cases');
      const badge = document.getElementById('home-alerts-badge');
      const badgeText = document.getElementById('home-alerts-badge-text');
      if (!container) return;

      try {
        const resp = await fetch(
          'https://baytidesstorage.blob.core.windows.net/missing-persons/missing-persons.json',
          { signal: AbortSignal.timeout(5000) }
        );
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const cases = (data.cases || []).slice(0, 3);

        if (cases.length === 0) {
          container.textContent = '';
          const p = document.createElement('p');
          p.className = 'text-xs text-neutral-700 dark:text-neutral-400';
          p.textContent = 'No recent reports in the Bay Area';
          container.appendChild(p);
          return;
        }

        // Show badge
        if (badge && badgeText) {
          badgeText.textContent = `${cases.length} recent`;
          badge.classList.remove('hidden');
        }

        // Render case rows with photos
        container.textContent = '';
        for (const c of cases) {
          const row = document.createElement('div');
          row.className = 'flex items-center gap-2';

          const photoWrap = document.createElement('div');
          photoWrap.className =
            'w-8 h-8 rounded bg-neutral-100 dark:bg-neutral-700 flex-shrink-0 overflow-hidden';
          if (c.photoUrl) {
            const img = document.createElement('img');
            img.src = c.photoUrl;
            img.alt = `Photo of ${c.name}`;
            img.className = 'w-full h-full object-cover';
            img.loading = 'lazy';
            photoWrap.appendChild(img);
          } else {
            photoWrap.className +=
              ' flex items-center justify-center text-neutral-700 dark:text-neutral-500';
            // Static SVG icon — no dynamic data
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('class', 'w-4 h-4');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('viewBox', '0 0 24 24');
            svg.setAttribute('stroke', 'currentColor');
            svg.setAttribute('stroke-width', '1.5');
            svg.setAttribute('aria-hidden', 'true');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('stroke-linecap', 'round');
            path.setAttribute('stroke-linejoin', 'round');
            path.setAttribute(
              'd',
              'M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0'
            );
            svg.appendChild(path);
            photoWrap.appendChild(svg);
          }

          const info = document.createElement('div');
          info.className = 'min-w-0';
          const nameDiv = document.createElement('div');
          nameDiv.className = 'text-xs font-medium text-neutral-900 dark:text-white truncate';
          nameDiv.textContent = c.name + (c.age ? `, now ${c.age}` : '');
          const metaDiv = document.createElement('div');
          metaDiv.className = 'text-xs text-neutral-700 dark:text-neutral-400';
          metaDiv.textContent = `${c.missingFrom?.city || ''} \u00B7 Missing since ${c.missingDate || ''}`;
          info.appendChild(nameDiv);
          info.appendChild(metaDiv);

          row.appendChild(photoWrap);
          row.appendChild(info);
          container.appendChild(row);
        }
      } catch {
        container.textContent = '';
        const p = document.createElement('p');
        p.className = 'text-xs text-neutral-700 dark:text-neutral-400';
        p.textContent = 'No recent reports in the Bay Area';
        container.appendChild(p);
      }
    })();
  </script>
</BaseLayout>
